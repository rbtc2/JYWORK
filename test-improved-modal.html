<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>개선된 모달 테스트</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .mini-map-container {
            background: #f3f4f6;
            border: 1px solid #e5e7eb;
        }
    </style>
</head>
<body class="bg-gray-100 p-8">
    <div class="max-w-4xl mx-auto">
        <h1 class="text-3xl font-bold text-gray-800 mb-8">개선된 showEntryDetail 모달 테스트</h1>
        
        <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
            <h2 class="text-xl font-semibold text-gray-800 mb-4">테스트 데이터</h2>
            <p class="text-gray-600 mb-2">이 페이지는 개선된 showEntryDetail 모달의 기능을 테스트합니다.</p>
            <p class="text-gray-600 mb-4">아래 버튼을 클릭하여 모달을 열어보세요.</p>
            
            <button onclick="showTestModal()" 
                    class="bg-blue-500 hover:bg-blue-600 text-white px-6 py-3 rounded-lg font-medium transition-colors">
                🧠 스마트 인사이트 모달 열기
            </button>
        </div>

        <div class="bg-white rounded-lg shadow-lg p-6">
            <h2 class="text-xl font-semibold text-gray-800 mb-4">주요 개선사항</h2>
            <ul class="space-y-2 text-gray-600">
                <li>✅ <strong>스마트 컨텍스트 섹션</strong> - 방문 횟수, 이전 방문일, 국가 총 체류일, 전체 해외 체류일 비율 등</li>
                <li>✅ <strong>UI 구조 개선</strong> - 기본 정보, 스마트 인사이트, 추가 정보를 명확히 구분</li>
                <li>✅ <strong>동행자/메모 조건부 표시</strong> - 있을 때만 표시하여 불필요한 정보 숨김</li>
                <li>✅ <strong>일관된 디자인</strong> - 섹션별 헤더와 구분선으로 가독성 향상</li>
                <li>✅ <strong>반응형 레이아웃</strong> - 모바일과 데스크탑 모두 최적화</li>
            </ul>
        </div>
    </div>

    <script>
        // 테스트용 데이터
        const testEntries = [
            {
                id: '1',
                city: '필라델피아',
                country: '미국',
                countryCode: 'US',
                startDate: '2025-08-26',
                endDate: '2025-08-28',
                purpose: 'study',
                rating: 5,
                companions: '가족',
                companionType: 'family',
                memo: '정말 좋았던 여행이었습니다. 특히 자유의 종을 보는 것이 인상적이었어요.'
            },
            {
                id: '2',
                city: '필라델피아',
                country: '미국',
                countryCode: 'US',
                startDate: '2024-12-15',
                endDate: '2024-12-20',
                purpose: 'tourism',
                rating: 4,
                companions: '혼자',
                companionType: 'alone',
                memo: '크리스마스 시즌의 필라델피아는 정말 아름다웠습니다.'
            },
            {
                id: '3',
                city: '뉴욕',
                country: '미국',
                countryCode: 'US',
                startDate: '2024-06-10',
                endDate: '2024-06-15',
                purpose: 'business',
                rating: 3,
                companions: '동료',
                companionType: 'colleagues',
                memo: '업무로 방문했지만 자유시간에 타임스퀘어를 구경할 수 있었습니다.'
            }
        ];

        // 전역 변수 설정 (테스트용)
        window.entries = testEntries;
        window.userResidence = {
            country: '한국',
            countryCode: 'KR',
            city: '서울'
        };

        // 유틸리티 함수들 (테스트용)
        function calculateDays(startDate, endDate) {
            if (!startDate || !endDate) return 0;
            const start = new Date(startDate);
            const end = new Date(endDate);
            const diffTime = Math.abs(end - start);
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
            return diffDays + 1;
        }

        function getVisitStats(cityName, countryCode, entries) {
            if (!entries || !Array.isArray(entries)) {
                return {
                    visitCount: 0,
                    totalDays: 0,
                    previousVisit: null,
                    longestStay: 0,
                    highestRating: 0,
                    averageRating: 0
                };
            }

            const cityEntries = entries.filter(entry => 
                entry.city === cityName && entry.countryCode === countryCode
            );

            if (cityEntries.length === 0) {
                return {
                    visitCount: 0,
                    totalDays: 0,
                    previousVisit: null,
                    longestStay: 0,
                    highestRating: 0,
                    averageRating: 0
                };
            }

            const visitCount = cityEntries.length;
            const totalDays = cityEntries.reduce((total, entry) => {
                const days = calculateDays(entry.startDate, entry.endDate);
                return total + days;
            }, 0);

            const sortedEntries = cityEntries
                .sort((a, b) => new Date(b.startDate) - new Date(a.startDate));
            
            const previousVisit = sortedEntries.length > 1 ? sortedEntries[1] : null;

            const longestStay = Math.max(...cityEntries.map(entry => 
                calculateDays(entry.startDate, entry.endDate)
            ));

            const ratings = cityEntries
                .map(entry => entry.rating || 0)
                .filter(rating => rating > 0);
            
            const highestRating = ratings.length > 0 ? Math.max(...ratings) : 0;
            const averageRating = ratings.length > 0 ? 
                Math.round((ratings.reduce((sum, rating) => sum + rating, 0) / ratings.length) * 10) / 10 : 0;

            return {
                visitCount,
                totalDays,
                previousVisit,
                longestStay,
                highestRating,
                averageRating
            };
        }

        function getCountryStats(countryCode, entries) {
            if (!entries || !Array.isArray(entries)) {
                return { totalDays: 0, visitCount: 0, cities: [] };
            }

            const countryEntries = entries.filter(entry => 
                entry.countryCode === countryCode
            );

            if (countryEntries.length === 0) {
                return { totalDays: 0, visitCount: 0, cities: [] };
            }

            const totalDays = countryEntries.reduce((total, entry) => {
                const days = calculateDays(entry.startDate, entry.endDate);
                return total + days;
            }, 0);

            const visitCount = countryEntries.length;
            const cities = [...new Set(countryEntries.map(entry => entry.city))];

            return { totalDays, visitCount, cities };
        }

        function getTotalOverseasDays(entries, userResidence) {
            if (!entries || !Array.isArray(entries)) return 0;

            let totalDays = 0;
            entries.forEach(entry => {
                if (userResidence && userResidence.countryCode && 
                    entry.countryCode === userResidence.countryCode) {
                    return;
                }
                const days = calculateDays(entry.startDate, entry.endDate);
                totalDays += days;
            });

            return totalDays;
        }

        // 국가 코드를 한국어 국가 이름으로 변환
        function getCountryName(countryCode) {
            if (!countryCode) return '알 수 없음';
            
            const countryNames = {
                'KR': '한국',
                'JP': '일본',
                'CN': '중국',
                'US': '미국',
                'GB': '영국',
                'FR': '프랑스',
                'DE': '독일',
                'IT': '이탈리아',
                'ES': '스페인',
                'NL': '네덜란드',
                'BE': '벨기에',
                'CH': '스위스',
                'AT': '오스트리아',
                'SE': '스웨덴',
                'NO': '노르웨이',
                'DK': '덴마크',
                'AU': '호주',
                'CA': '캐나다',
                'NZ': '뉴질랜드',
                'SG': '싱가포르',
                'TH': '태국',
                'MY': '말레이시아',
                'VN': '베트남',
                'IN': '인도',
                'BR': '브라질',
                'MX': '멕시코',
                'RU': '러시아',
                'TR': '터키',
                'PL': '폴란드',
                'CZ': '체코',
                'HU': '헝가리',
                'FI': '핀란드',
                'IE': '아일랜드',
                'PT': '포르투갈'
            };
            
            return countryNames[countryCode] || countryCode;
        }

        function getCityHistory(entry, entries, userResidence) {
            const cityStats = getVisitStats(entry.city, entry.countryCode, entries);
            const countryStats = getCountryStats(entry.countryCode, entries);
            const totalOverseasDays = getTotalOverseasDays(entries, userResidence);
            const countryName = getCountryName(entry.countryCode);

            let previousVisitText = null;
            if (cityStats.previousVisit) {
                const prevDate = new Date(cityStats.previousVisit.startDate);
                const year = prevDate.getFullYear();
                const month = prevDate.getMonth() + 1;
                previousVisitText = `${year}년 ${month}월`;
            }

            const overseasPercentage = totalOverseasDays > 0 ? 
                Math.round((countryStats.totalDays / totalOverseasDays) * 100) : 0;

            return {
                cityStats,
                countryStats,
                totalOverseasDays,
                previousVisitText,
                overseasPercentage,
                countryName
            };
        }

        function getCompanionText(entry) {
            if (!entry) return '없음';
            
            // companionType이 없거나 빈 문자열인 경우
            if (!entry.companionType || entry.companionType === '') {
                return '없음';
            }
            
            if (typeof entry.companions === 'string') {
                return entry.companions.trim() || '없음';
            }
            
            if (entry.companions && typeof entry.companions === 'object') {
                if (entry.companions.type === 'none') return '없음';
                if (entry.companions.type === 'alone') return '혼자';
                if (entry.companions.type === 'friends') return '친구';
                if (entry.companions.type === 'colleagues') return '동료';
                if (entry.companions.type === 'custom' && entry.companions.value) {
                    return entry.companions.value;
                }
                return '없음';
            }
            
            return '없음';
        }

        function getPurposeText(purpose) {
            if (!purpose) return '기타';
            
            const purposeMap = {
                'tourism': '관광',
                'business': '업무',
                'study': '유학',
                'work': '근무',
                'family': '가족 방문',
                'medical': '의료',
                'other': '기타'
            };
            
            return purposeMap[purpose] || purpose;
        }

        function generateStarRating(rating) {
            if (!rating || rating < 1) rating = 0;
            
            let stars = '';
            for (let i = 1; i <= 5; i++) {
                if (i <= rating) {
                    stars += '<span class="text-yellow-400">⭐</span>';
                } else {
                    stars += '<span class="text-gray-300">⭐</span>';
                }
            }
            return stars;
        }

        function sanitizeMemo(memo) {
            return memo || '';
        }

        function isMemoTruncated(memo, maxLength = 100) {
            return memo && memo.length > maxLength;
        }

        function truncateMemoForDetail(memo, maxLength = 100) {
            return memo ? memo.substring(0, maxLength) + '...' : '';
        }

        // 테스트 모달 표시
        function showTestModal() {
            const entry = testEntries[0]; // 첫 번째 항목으로 테스트
            const days = calculateDays(entry.startDate, entry.endDate);
            const purposeText = getPurposeText(entry.purpose);
            const flag = '🇺🇸';
            const countryName = entry.country;
            const cityName = entry.city;

            // 스마트 컨텍스트 정보 계산
            const cityHistory = getCityHistory(entry, testEntries, window.userResidence);
                    const hasCompanions = entry.companionType && entry.companionType !== '' && entry.companions && (
            (typeof entry.companions === 'string' && entry.companions.trim()) ||
            (typeof entry.companions === 'object' && entry.companions.type !== 'none')
        );
            const hasMemo = entry.memo && entry.memo.trim();

            const modalHTML = `
                <div id="entry-detail-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
                    <div class="bg-white rounded-xl shadow-lg max-w-2xl w-full max-h-[90vh] overflow-y-auto">
                        <!-- 헤더 -->
                        <div class="flex justify-between items-start sm:items-center p-4 sm:p-6 border-b border-gray-100 relative">
                            <div class="flex items-start sm:items-center space-x-3 sm:space-x-4 flex-1 min-w-0 pr-12">
                                <span class="text-3xl sm:text-4xl flex-shrink-0" aria-label="${countryName} 국기">${flag}</span>
                                <div class="flex-1 min-w-0">
                                    <div class="block sm:hidden">
                                        <h2 class="text-lg font-bold text-gray-800 truncate">${cityName}, ${countryName}</h2>
                                    </div>
                                    <div class="hidden sm:block">
                                        <h2 class="text-xl sm:text-2xl font-bold text-gray-800 truncate">${cityName}, ${countryName}</h2>
                                    </div>
                                    <p class="text-sm sm:text-lg text-gray-600 mt-1 truncate">${entry.startDate} ~ ${entry.endDate}</p>
                                </div>
                            </div>
                            <button onclick="closeTestModal()" 
                                    class="absolute top-4 right-4 sm:relative sm:top-auto sm:right-auto text-gray-400 hover:text-gray-600 text-xl sm:text-2xl font-bold flex-shrink-0 w-10 h-10 sm:w-12 sm:h-12 flex items-center justify-center rounded-full hover:bg-gray-100 transition-colors"
                                    aria-label="모달 닫기">
                                ×
                            </button>
                        </div>

                        <!-- 카드 본문 -->
                        <div class="p-6 space-y-6">
                            <!-- 기본 정보 섹션 -->
                            <div class="space-y-4">
                                <h3 class="text-lg font-semibold text-gray-800 border-b border-gray-200 pb-2">📋 기본 정보</h3>
                                
                                <div class="flex items-center justify-between">
                                    <div class="flex items-center space-x-3">
                                        <span class="text-2xl">📅</span>
                                        <div>
                                            <p class="text-sm text-gray-500">체류 기간</p>
                                            <p class="text-lg font-semibold text-gray-800">${entry.startDate} ~ ${entry.endDate}</p>
                                        </div>
                                    </div>
                                    <div class="text-right">
                                        <p class="text-sm text-gray-500">총 체류 일수</p>
                                        <p class="text-xl font-bold text-blue-600">${days}일</p>
                                    </div>
                                </div>
                                
                                <div class="flex items-center space-x-3">
                                    <span class="text-2xl">🎯</span>
                                    <div>
                                        <p class="text-sm text-gray-500">체류 목적</p>
                                        <p class="text-lg font-semibold text-gray-800">${purposeText}</p>
                                    </div>
                                </div>

                                <div class="flex items-center justify-between">
                                    <div class="flex items-center space-x-3">
                                        <span class="text-2xl">⭐</span>
                                        <div>
                                            <p class="text-sm text-gray-500">별점 평가</p>
                                            <p class="text-lg font-semibold text-gray-800">${entry.rating || 0}점</p>
                                        </div>
                                    </div>
                                    <div class="flex items-center space-x-1">
                                        ${generateStarRating(entry.rating || 0)}
                                    </div>
                                </div>
                            </div>

                            <!-- 스마트 컨텍스트 섹션 (항상 표시) -->
                            <div class="bg-blue-50 rounded-lg p-6 space-y-4">
                                <h3 class="text-lg font-semibold text-blue-800 border-b border-blue-200 pb-2">🧠 스마트 인사이트</h3>
                                
                                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                                    <div class="flex items-center space-x-3">
                                        <span class="text-2xl">🔄</span>
                                        <div>
                                            <p class="text-sm text-blue-600">방문 횟수</p>
                                            <p class="text-lg font-semibold text-blue-800">
                                                ${cityName} ${cityHistory.cityStats.visitCount}번째 방문
                                                ${cityHistory.previousVisitText ? `(이전: ${cityHistory.previousVisitText})` : ''}
                                            </p>
                                        </div>
                                    </div>
                                    
                                    <div class="flex items-center space-x-3">
                                        <span class="text-2xl">💡</span>
                                        <div>
                                            <p class="text-sm text-blue-600">국가 총 체류일</p>
                                            <p class="text-lg font-semibold text-blue-800">
                                                ${countryName} 총 ${cityHistory.countryStats.totalDays}일
                                            </p>
                                        </div>
                                    </div>
                                    
                                    <div class="flex items-center space-x-3">
                                        <span class="text-2xl">🌍</span>
                                        <div>
                                            <p class="text-sm text-blue-600">전체 해외 체류일</p>
                                            <p class="text-lg font-semibold text-blue-800">
                                                ${cityHistory.totalOverseasDays}일 중 ${cityHistory.overseasPercentage}%
                                            </p>
                                        </div>
                                    </div>
                                    
                                    <div class="flex items-center space-x-3">
                                        <span class="text-2xl">🏆</span>
                                        <div>
                                            <p class="text-sm text-blue-600">${cityHistory.countryName} 방문 기록</p>
                                            <p class="text-lg font-semibold text-blue-800">
                                                최장 체류: ${cityHistory.cityStats.longestStay}일
                                                ${cityHistory.cityStats.highestRating > 0 ? `| 최고 별점: ${cityHistory.cityStats.highestRating}점` : ''}
                                            </p>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- 선택적 정보 섹션 (있을 때만 표시) -->
                            ${hasCompanions || hasMemo ? `
                            <div class="space-y-4">
                                <h3 class="text-lg font-semibold text-gray-800 border-b border-gray-200 pb-2">📝 추가 정보</h3>
                                
                                ${hasCompanions ? `
                                <div class="flex items-start space-x-3">
                                    <span class="text-2xl mt-1">👥</span>
                                    <div class="flex-1">
                                        <p class="text-sm text-gray-500">동행자</p>
                                        <p class="text-lg font-semibold text-gray-800">${getCompanionText(entry)}</p>
                                    </div>
                                </div>
                                ` : ''}
                                
                                ${hasMemo ? `
                                <div class="bg-gray-50 rounded-lg p-6 space-y-4">
                                    <div class="flex items-start space-x-3">
                                        <span class="text-2xl mt-1">📝</span>
                                        <div class="flex-1">
                                            <p class="text-sm text-gray-500">메모</p>
                                            <div class="text-lg font-semibold text-gray-800">
                                                <div id="memo-content-${entry.id}" class="memo-content">
                                                    <span id="memo-text-${entry.id}">${isMemoTruncated(entry.memo, 100) ? truncateMemoForDetail(entry.memo) : sanitizeMemo(entry.memo)}</span>
                                                    ${isMemoTruncated(entry.memo, 100) ? `
                                                        <button onclick="toggleMemoDetail('${entry.id}')" class="ml-2 text-blue-600 hover:text-blue-800 text-sm font-medium underline">
                                                            더보기
                                                        </button>
                                                    ` : ''}
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                ` : ''}
                            </div>
                            ` : ''}

                            <!-- 위치 지도 -->
                            <div class="mt-6">
                                <h3 class="text-lg font-semibold text-gray-800 border-b border-gray-200 pb-2 mb-4">🗺️ 위치 정보</h3>
                                <div class="flex items-center space-x-3 mb-4">
                                    <span class="text-2xl">📍</span>
                                    <div>
                                        <p class="text-sm text-gray-500">위치</p>
                                        <p class="text-lg font-semibold text-gray-800">${cityName}, ${countryName}</p>
                                    </div>
                                </div>
                                <div class="bg-gray-100 rounded-lg overflow-hidden h-48 flex items-center justify-center">
                                    <div class="text-center">
                                        <p class="text-gray-500 text-sm">📍 위치 정보를 확인할 수 없습니다</p>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- 하단 버튼 -->
                        <div class="p-6 border-t border-gray-100">
                            <div class="flex justify-center">
                                <div class="flex space-x-2 max-w-md w-full">
                                    <button onclick="closeTestModal()" 
                                            class="flex-1 px-4 py-2.5 bg-gray-500 text-white rounded-lg hover:bg-gray-600 focus:bg-gray-600 focus:outline-none focus:ring-2 focus:ring-gray-500 focus:ring-offset-2 transition-colors text-sm font-medium min-h-[40px]">
                                        ✕ 닫기
                                    </button>
                                    <button onclick="alert('수정 기능은 실제 앱에서만 작동합니다')" 
                                            class="flex-1 px-4 py-2.5 bg-yellow-500 text-white rounded-lg hover:bg-yellow-600 focus:bg-yellow-600 focus:outline-none focus:ring-2 focus:ring-yellow-500 focus:ring-offset-2 transition-colors text-sm font-medium min-h-[40px]">
                                        ✏️ 수정
                                    </button>
                                    <button onclick="alert('삭제 기능은 실제 앱에서만 작동합니다')" 
                                            class="flex-1 px-4 py-2.5 bg-red-500 text-white rounded-lg hover:bg-red-600 focus:bg-red-600 focus:outline-none focus:ring-2 focus:ring-red-500 focus:ring-offset-2 transition-colors text-sm font-medium min-h-[40px]">
                                        🗑️ 삭제
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            document.body.insertAdjacentHTML('beforeend', modalHTML);
        }

        function closeTestModal() {
            const modal = document.getElementById('entry-detail-modal');
            if (modal) {
                modal.remove();
            }
        }

        function toggleMemoDetail(entryId) {
            const memoText = document.getElementById(`memo-text-${entryId}`);
            const memoContent = document.getElementById(`memo-content-${entryId}`);
            
            if (memoText && memoContent) {
                const entry = testEntries.find(e => e.id === entryId);
                if (entry && entry.memo) {
                    if (memoText.textContent.includes('...')) {
                        memoText.textContent = entry.memo;
                        memoText.nextElementSibling.textContent = '접기';
                    } else {
                        memoText.textContent = truncateMemoForDetail(entry.memo);
                        memoText.nextElementSibling.textContent = '더보기';
                    }
                }
            }
        }
    </script>
</body>
</html>
