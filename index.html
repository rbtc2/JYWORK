<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>세계 여행 앱</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <!-- Leaflet JavaScript -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        .nav-tab {
            transition: all 0.3s ease;
        }
        
        .nav-tab:hover {
            background-color: #f3f4f6;
        }
        
        .nav-tab.active {
            background-color: #3b82f6;
            color: white;
        }
        
        @media (max-width: 640px) {
            .nav-container {
                padding: 0.5rem;
            }
            
            .nav-tab {
                padding: 0.75rem 0.5rem;
                font-size: 0.875rem;
            }
        }

        /* 캘린더 이벤트 스타일 (구글 캘린더 스타일) */
        .calendar-event {
            display: block;
            width: 100%;
            padding: 2px 6px;
            margin: 1px 0;
            border-radius: 3px;
            font-size: 0.75rem;
            font-weight: 500;
            color: white;
            cursor: pointer;
            transition: all 0.2s ease;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            border-left: 3px solid;
        }

        .calendar-event:hover {
            transform: scale(1.02);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }

        /* 이벤트 색상 변형 */
        .calendar-event.event-1 { background-color: #4285f4; border-left-color: #1a73e8; }
        .calendar-event.event-2 { background-color: #ea4335; border-left-color: #d93025; }
        .calendar-event.event-3 { background-color: #fbbc04; border-left-color: #f9ab00; }
        .calendar-event.event-4 { background-color: #34a853; border-left-color: #137333; }
        .calendar-event.event-5 { background-color: #9c27b0; border-left-color: #7b1fa2; }
        .calendar-event.event-6 { background-color: #ff9800; border-left-color: #f57c00; }
        .calendar-event.event-7 { background-color: #795548; border-left-color: #5d4037; }
        .calendar-event.event-8 { background-color: #607d8b; border-left-color: #455a64; }

        /* 툴팁 스타일 */
        .calendar-tooltip {
            animation: tooltipFadeIn 0.2s ease-out;
        }

        @keyframes tooltipFadeIn {
            from {
                opacity: 0;
                transform: translateY(-5px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* 모바일에서 터치 영역 확대 */
        @media (max-width: 768px) {
            .calendar-event {
                padding: 3px 8px;
                font-size: 0.8rem;
                margin: 2px 0;
            }
            
            /* 모바일에서 캘린더 네비게이션 최적화 */
            #year-select, #month-select {
                font-size: 0.875rem;
                padding: 0.5rem 0.75rem;
            }
        }

        /* 지도 마커 스타일 */
        .custom-marker {
            background: none;
            border: none;
        }

        .marker-pin {
            font-size: 24px;
            filter: drop-shadow(2px 2px 2px rgba(0,0,0,0.3));
            cursor: pointer;
            transition: transform 0.2s ease;
        }

        .marker-pin:hover {
            transform: scale(1.2);
        }

        /* 팝업 스타일 */
        .custom-popup .leaflet-popup-content-wrapper {
            background: white;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .custom-popup .leaflet-popup-content {
            margin: 0;
            padding: 0;
        }

        .popup-content {
            padding: 12px;
        }

        /* 지도 컨테이너 반응형 */
        @media (max-width: 768px) {
            #map-container {
                height: 60vh !important;
                max-height: 400px !important;
            }
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <!-- 네비게이션 바 -->
    <nav class="bg-white shadow-sm border-b border-gray-200 sticky top-0 z-50">
        <div class="nav-container max-w-4xl mx-auto px-4">
            <div class="flex justify-between items-center">
                <div class="text-xl font-bold text-gray-800 py-4">
                    🌍 여행 앱
                </div>
                
                <!-- 사용자 정보 및 로그인 버튼 -->
                <div class="flex items-center space-x-4">
                    <!-- 로그인된 사용자 정보 (기본적으로 숨김) -->
                    <div id="user-info" class="hidden flex items-center space-x-2">
                        <div class="w-8 h-8 bg-blue-500 rounded-full flex items-center justify-center">
                            <span class="text-white text-sm font-medium" id="user-initial">U</span>
                        </div>
                        <span class="text-sm font-medium text-gray-700" id="username">사용자</span>
                    </div>
                    
                    <!-- 로그인/로그아웃 버튼 -->
                    <div class="flex items-center space-x-2">
                        <button id="login-btn" class="text-sm text-blue-600 hover:text-blue-800 font-medium transition-colors">
                            로그인
                        </button>
                        <button id="logout-btn" class="hidden text-sm text-gray-600 hover:text-gray-800 font-medium transition-colors">
                            로그아웃
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- 탭 네비게이션 -->
            <div class="flex space-x-1 pb-2">
                <button class="nav-tab active flex-1 py-3 px-4 rounded-lg text-sm font-medium text-center transition-colors" data-section="world-map">
                    🗺️ 세계지도
                </button>
                <button class="nav-tab flex-1 py-3 px-4 rounded-lg text-sm font-medium text-center transition-colors text-gray-600" data-section="dashboard">
                    📊 대시보드
                </button>
                <button class="nav-tab flex-1 py-3 px-4 rounded-lg text-sm font-medium text-center transition-colors text-gray-600" data-section="timeline">
                    ⏰ 타임라인
                </button>
                <button class="nav-tab flex-1 py-3 px-4 rounded-lg text-sm font-medium text-center transition-colors text-gray-600" data-section="calendar">
                    📅 캘린더
                </button>
                <button class="nav-tab flex-1 py-3 px-4 rounded-lg text-sm font-medium text-center transition-colors text-gray-600" data-section="settings">
                    ⚙️ 설정
                </button>
            </div>
        </div>
    </nav>

    <!-- 메인 콘텐츠 -->
    <main class="max-w-4xl mx-auto px-4 py-8">
        <!-- 세계지도 섹션 -->
        <section id="world-map" class="content-section block">
            <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-8">
                <div class="text-center mb-8">
                    <div class="text-6xl mb-6">🗺️</div>
                    <h1 class="text-3xl font-bold text-gray-800 mb-4">세계지도</h1>
                    <p class="text-gray-600 text-lg leading-relaxed max-w-2xl mx-auto">
                        전 세계 여행지를 인터랙티브 지도에서 탐색하세요. 
                        방문한 도시들이 지도에 마커로 표시되며, 
                        마커를 클릭하면 상세 정보를 확인할 수 있습니다.
                    </p>
                </div>
                
                <!-- 지도 컨테이너 -->
                <div id="map-container" class="w-full h-[80vh] max-h-[600px] rounded-xl shadow-md mb-16 overflow-hidden">
                    <div id="world-map" class="w-full h-full"></div>
                </div>
                
                <!-- 지도 컨트롤 -->
                <div class="mt-4 flex flex-wrap gap-2 justify-center">
                    <button id="fit-bounds-btn" class="px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition-colors text-sm">
                        전체 보기
                    </button>
                    <button id="clear-markers-btn" class="px-4 py-2 bg-gray-500 text-white rounded-lg hover:bg-gray-600 transition-colors text-sm">
                        마커 숨기기
                    </button>
                    <button id="show-markers-btn" class="px-4 py-2 bg-green-500 text-white rounded-lg hover:bg-green-600 transition-colors text-sm">
                        마커 보기
                    </button>
                </div>
                
                <!-- 마커 정보 패널 -->
                <div id="marker-info-panel" class="mt-4 bg-gray-50 rounded-lg p-4 hidden">
                    <h3 class="text-lg font-semibold text-gray-800 mb-2">방문 도시 정보</h3>
                    <div id="marker-info-content" class="text-sm text-gray-600">
                        <!-- 여기에 마커 정보가 동적으로 추가됩니다 -->
                    </div>
                </div>
            </div>
        </section>

        <!-- 대시보드 섹션 -->
        <section id="dashboard" class="content-section hidden">
            <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-8">
                <div class="text-center mb-8">
                    <div class="text-6xl mb-6">📊</div>
                    <h1 class="text-3xl font-bold text-gray-800 mb-4">대시보드</h1>
                    <p class="text-gray-600 text-lg leading-relaxed max-w-2xl mx-auto">
                        여행 통계와 분석 데이터를 한눈에 확인하세요. 
                        방문한 국가 수, 총 여행 거리, 소요된 시간 등 
                        다양한 여행 데이터를 시각적으로 확인할 수 있습니다.
                    </p>
                </div>
                
                <!-- 통계 카드들 -->
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                    <div class="bg-blue-50 rounded-xl p-6 text-center">
                        <div class="text-3xl font-bold text-blue-600 mb-2" id="total-countries">0</div>
                        <div class="text-blue-800 font-medium">방문 국가</div>
                    </div>
                    <div class="bg-green-50 rounded-xl p-6 text-center">
                        <div class="text-3xl font-bold text-green-600 mb-2" id="total-cities">0</div>
                        <div class="text-green-800 font-medium">방문 도시</div>
                    </div>
                    <div class="bg-purple-50 rounded-xl p-6 text-center">
                        <div class="text-3xl font-bold text-purple-600 mb-2" id="total-days">0</div>
                        <div class="text-purple-800 font-medium">총 체류일</div>
                    </div>
                </div>
                
                <!-- 추가 통계 -->
                <div class="bg-gray-50 rounded-xl p-6">
                    <h3 class="text-lg font-semibold text-gray-800 mb-4">여행 요약</h3>
                    <div id="travel-summary" class="text-gray-600">
                        <!-- 여기에 동적으로 요약 정보가 추가됩니다 -->
                    </div>
                </div>
            </div>
        </section>

        <!-- 타임라인 섹션 -->
        <section id="timeline" class="content-section hidden">
            <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-8">
                <div class="text-center mb-8">
                    <div class="text-6xl mb-6">⏰</div>
                    <h1 class="text-3xl font-bold text-gray-800 mb-4">타임라인</h1>
                    <p class="text-gray-600 text-lg leading-relaxed max-w-2xl mx-auto">
                        여행 일정을 시간순으로 정리하고 관리하세요. 
                        각 여행의 시작과 끝, 주요 일정들을 타임라인 형태로 
                        시각화하여 전체 여행 흐름을 한눈에 파악할 수 있습니다.
                    </p>
                </div>
                
                <!-- 타임라인 목록 -->
                <div id="timeline-list" class="space-y-4">
                    <!-- 여기에 동적으로 타임라인 카드들이 추가됩니다 -->
                </div>
                
                <!-- 빈 상태 메시지 -->
                <div id="timeline-empty" class="text-center py-12">
                    <div class="text-4xl mb-4">📝</div>
                    <p class="text-gray-500 text-lg">아직 등록된 여행 일정이 없습니다.</p>
                    <p class="text-gray-400 text-sm mt-2">우측 하단의 + 버튼을 눌러 첫 여행을 추가해보세요!</p>
                </div>
            </div>
        </section>

        <!-- 캘린더 섹션 -->
        <section id="calendar" class="content-section hidden">
            <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-8">
                <div class="text-center mb-8">
                    <div class="text-6xl mb-6">📅</div>
                    <h1 class="text-3xl font-bold text-gray-800 mb-4">캘린더</h1>
                    <p class="text-gray-600 text-lg leading-relaxed max-w-2xl mx-auto">
                        월별 캘린더로 여행 일정을 시각적으로 확인하세요. 
                        각 날짜에 방문한 곳과 예정된 여행을 표시하여 
                        전체적인 여행 일정을 체계적으로 관리할 수 있습니다.
                    </p>
                </div>
                
                <!-- 캘린더 네비게이션 -->
                <div class="flex flex-col sm:flex-row justify-between items-center mb-6 gap-4">
                    <!-- 연도/월 선택 드롭다운 -->
                    <div class="flex items-center gap-3">
                        <select id="year-select" class="px-3 py-2 border border-gray-300 rounded-lg text-gray-700 bg-white hover:border-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-colors">
                            <!-- 연도 옵션들이 동적으로 생성됩니다 -->
                        </select>
                        <span class="text-gray-600 font-medium">년</span>
                        <select id="month-select" class="px-3 py-2 border border-gray-300 rounded-lg text-gray-700 bg-white hover:border-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-colors">
                            <option value="0">1월</option>
                            <option value="1">2월</option>
                            <option value="2">3월</option>
                            <option value="3">4월</option>
                            <option value="4">5월</option>
                            <option value="5">6월</option>
                            <option value="6">7월</option>
                            <option value="7">8월</option>
                            <option value="8">9월</option>
                            <option value="9">10월</option>
                            <option value="10">11월</option>
                            <option value="11">12월</option>
                        </select>
                    </div>
                    
                    <!-- 현재 월 표시 -->
                    <h2 id="current-month" class="text-xl font-semibold text-gray-800">2024년 1월</h2>
                    
                    <!-- 이전/다음 버튼 -->
                    <div class="flex items-center gap-2">
                        <button id="prev-month" class="px-4 py-2 text-gray-600 hover:text-gray-800 transition-colors">
                            ← 이전
                        </button>
                        <button id="next-month" class="px-4 py-2 text-gray-600 hover:text-gray-800 transition-colors">
                            다음 →
                        </button>
                    </div>
                </div>
                
                <!-- 캘린더 테이블 -->
                <div class="overflow-x-auto">
                    <table id="calendar-table" class="w-full border-collapse">
                        <thead>
                            <tr class="bg-gray-50">
                                <th class="p-3 text-center text-sm font-medium text-gray-600">일</th>
                                <th class="p-3 text-center text-sm font-medium text-gray-600">월</th>
                                <th class="p-3 text-center text-sm font-medium text-gray-600">화</th>
                                <th class="p-3 text-center text-sm font-medium text-gray-600">수</th>
                                <th class="p-3 text-center text-sm font-medium text-gray-600">목</th>
                                <th class="p-3 text-center text-sm font-medium text-gray-600">금</th>
                                <th class="p-3 text-center text-sm font-medium text-gray-600">토</th>
                            </tr>
                        </thead>
                        <tbody id="calendar-body">
                            <!-- 여기에 동적으로 캘린더가 생성됩니다 -->
                        </tbody>
                    </table>
                </div>
                
                <!-- 빈 상태 메시지 -->
                <div id="calendar-empty" class="text-center py-12">
                    <div class="text-4xl mb-4">📝</div>
                    <p class="text-gray-500 text-lg">아직 등록된 여행 일정이 없습니다.</p>
                    <p class="text-gray-400 text-sm mt-2">우측 하단의 + 버튼을 눌러 첫 여행을 추가해보세요!</p>
                </div>
            </div>
        </section>

        <!-- 설정 섹션 -->
        <section id="settings" class="content-section hidden">
            <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-8">
                <div class="text-center mb-8">
                    <div class="text-6xl mb-6">⚙️</div>
                    <h1 class="text-3xl font-bold text-gray-800 mb-4">설정</h1>
                    <p class="text-gray-600 text-lg leading-relaxed max-w-2xl mx-auto">
                        앱 설정과 사용자 정보를 관리하세요. 
                        테마 변경, 언어 설정, 계정 관리 등 
                        다양한 설정 옵션을 제공합니다.
                    </p>
                </div>
                
                <!-- 설정 카테고리들 -->
                <div class="space-y-6">
                    <!-- 계정 설정 -->
                    <div class="bg-gray-50 rounded-lg p-6">
                        <h3 class="text-lg font-semibold text-gray-800 mb-4">계정 설정</h3>
                        <div class="space-y-4">
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="font-medium text-gray-700">로그인 상태</p>
                                    <p class="text-sm text-gray-500" id="login-status">로그인되지 않음</p>
                                </div>
                                <button id="demo-login-btn" class="px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition-colors">
                                    데모 로그인
                                </button>
                            </div>
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="font-medium text-gray-700">사용자 데이터</p>
                                    <p class="text-sm text-gray-500">현재 저장된 여행 데이터</p>
                                </div>
                                <button id="export-data-btn" class="px-4 py-2 bg-green-500 text-white rounded-lg hover:bg-green-600 transition-colors">
                                    데이터 내보내기
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- 앱 설정 -->
                    <div class="bg-gray-50 rounded-lg p-6">
                        <h3 class="text-lg font-semibold text-gray-800 mb-4">앱 설정</h3>
                        <div class="space-y-4">
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="font-medium text-gray-700">다크 모드</p>
                                    <p class="text-sm text-gray-500">어두운 테마로 변경</p>
                                </div>
                                <button id="dark-mode-toggle" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition-colors">
                                    준비 중
                                </button>
                            </div>
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="font-medium text-gray-700">언어 설정</p>
                                    <p class="text-sm text-gray-500">한국어 / English</p>
                                </div>
                                <button id="language-toggle" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition-colors">
                                    준비 중
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- 데이터 관리 -->
                    <div class="bg-gray-50 rounded-lg p-6">
                        <h3 class="text-lg font-semibold text-gray-800 mb-4">데이터 관리</h3>
                        <div class="space-y-4">
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="font-medium text-gray-700">데이터 백업</p>
                                    <p class="text-sm text-gray-500">여행 데이터를 안전하게 백업</p>
                                </div>
                                <button id="backup-data-btn" class="px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition-colors">
                                    백업
                                </button>
                            </div>
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="font-medium text-gray-700">데이터 초기화</p>
                                    <p class="text-sm text-gray-500">모든 여행 데이터 삭제</p>
                                </div>
                                <button id="reset-data-btn" class="px-4 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600 transition-colors">
                                    초기화
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- 정보 -->
                    <div class="bg-gray-50 rounded-lg p-6">
                        <h3 class="text-lg font-semibold text-gray-800 mb-4">정보</h3>
                        <div class="space-y-2 text-sm text-gray-600">
                            <p><strong>앱 버전:</strong> 1.0.0</p>
                            <p><strong>개발자:</strong> 여행 앱 팀</p>
                            <p><strong>지원:</strong> 향후 Firebase Auth 또는 Supabase Auth 연동 예정</p>
                        </div>
                    </div>
                </div>
            </div>
        </section>
    </main>

    <!-- 플로팅 + 버튼 -->
    <button id="floating-btn" class="fixed bottom-6 right-6 w-14 h-14 bg-blue-500 hover:bg-blue-600 text-white rounded-full shadow-lg flex items-center justify-center transition-all duration-300 hover:scale-110 z-50">
        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
        </svg>
    </button>

    <!-- 모달 오버레이 -->
    <div id="modal-overlay" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden flex items-center justify-center p-4">
        <!-- 모달 창 -->
        <div class="bg-white rounded-xl shadow-xl w-11/12 max-w-md max-h-[90vh] overflow-y-auto">
            <!-- 모달 헤더 -->
            <div class="flex justify-between items-center p-6 border-b border-gray-200">
                <h2 class="text-xl font-bold text-gray-800">새 여행 추가</h2>
                <button id="close-modal" class="text-gray-400 hover:text-gray-600 transition-colors">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>

            <!-- 모달 내용 -->
            <form id="travel-form" class="p-6 space-y-4">
                <!-- 국가 선택 -->
                <div class="relative">
                    <label for="country-input" class="block text-sm font-medium text-gray-700 mb-2">국가 *</label>
                    <input 
                        type="text" 
                        id="country-input" 
                        name="country" 
                        required 
                        placeholder="국가명을 입력하거나 선택하세요" 
                        class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                        autocomplete="off"
                    >
                    <input type="hidden" id="country-code" name="countryCode">
                    <input type="hidden" id="country-label" name="countryLabel">
                    
                    <!-- 국가 드롭다운 목록 -->
                    <ul id="country-dropdown" class="absolute z-10 w-full mt-1 bg-white border border-gray-300 rounded-lg shadow-lg max-h-60 overflow-y-auto hidden">
                        <!-- 여기에 필터링된 국가 목록이 동적으로 추가됩니다 -->
                    </ul>
                </div>

                <!-- 도시 입력 -->
                <div class="relative">
                    <label for="city-input" class="block text-sm font-medium text-gray-700 mb-2">도시 *</label>
                    <input 
                        type="text" 
                        id="city-input" 
                        name="city" 
                        required 
                        placeholder="국가를 먼저 선택한 후 도시명을 입력하세요" 
                        class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                        autocomplete="off"
                        disabled
                    >
                    <input type="hidden" id="city-name" name="cityName">
                    
                    <!-- 도시 드롭다운 목록 -->
                    <ul id="city-dropdown" class="absolute z-10 w-full mt-1 bg-white border border-gray-300 rounded-lg shadow-lg max-h-60 overflow-y-auto hidden">
                        <!-- 여기에 필터링된 도시 목록이 동적으로 추가됩니다 -->
                    </ul>
                </div>

                <!-- 체류 시작일 -->
                <div>
                    <label for="start-date" class="block text-sm font-medium text-gray-700 mb-2">체류 시작일 *</label>
                    <input type="date" id="start-date" name="startDate" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                </div>

                <!-- 체류 종료일 -->
                <div>
                    <label for="end-date" class="block text-sm font-medium text-gray-700 mb-2">체류 종료일 *</label>
                    <input type="date" id="end-date" name="endDate" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                </div>

                <!-- 체류 목적 -->
                <div>
                    <label for="purpose" class="block text-sm font-medium text-gray-700 mb-2">체류 목적 *</label>
                    <select id="purpose" name="purpose" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                        <option value="">목적을 선택하세요</option>
                        <option value="travel">여행</option>
                        <option value="business">출장</option>
                        <option value="study">유학</option>
                        <option value="working-holiday">워킹 홀리데이</option>
                        <option value="family-visit">가족 방문</option>
                        <option value="dispatch">파견</option>
                        <option value="exchange">교환학생</option>
                        <option value="volunteer">봉사활동</option>
                        <option value="medical">의료</option>
                        <option value="language">어학 연수</option>
                        <option value="transit">비행 경유</option>
                    </select>
                </div>

                <!-- 메모 -->
                <div>
                    <label for="memo" class="block text-sm font-medium text-gray-700 mb-2">메모</label>
                    <textarea id="memo" name="memo" rows="3" placeholder="추가 메모를 입력하세요 (선택사항)" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 resize-none"></textarea>
                </div>

                <!-- 제출 버튼 -->
                <div class="flex space-x-3 pt-4">
                    <button type="button" id="cancel-btn" class="flex-1 px-4 py-2 text-gray-700 bg-gray-100 hover:bg-gray-200 rounded-lg transition-colors">
                        취소
                    </button>
                    <button type="submit" class="flex-1 px-4 py-2 bg-blue-500 hover:bg-blue-600 text-white rounded-lg transition-colors">
                        추가
                    </button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // 전역 변수
        let entries = [];
        let currentDate = new Date();
        
        // 사용자 관련 변수들
        let currentUser = {
            id: null,
            username: null,
            isLoggedIn: false
        };
        
        // 수정 모드 변수
        let isEditMode = false;
        let editingEntryId = null;
        
        // 국가 데이터 (code, label, aliases, enLabel 구조)
        const countries = [
            { code: 'KR', label: '대한민국', enLabel: 'South Korea', aliases: ['Korea', 'South Korea', '한국', '대한민국', 'Republic of Korea'] },
            { code: 'JP', label: '일본', enLabel: 'Japan', aliases: ['Japan', '일본', 'Nippon'] },
            { code: 'CN', label: '중국', enLabel: 'China', aliases: ['China', '중국', 'People\'s Republic of China'] },
            { code: 'US', label: '미국', enLabel: 'United States', aliases: ['USA', 'United States', '미국', 'America'] },
            { code: 'GB', label: '영국', enLabel: 'United Kingdom', aliases: ['UK', 'United Kingdom', '영국', 'Great Britain'] },
            { code: 'FR', label: '프랑스', enLabel: 'France', aliases: ['France', '프랑스'] },
            { code: 'DE', label: '독일', enLabel: 'Germany', aliases: ['Germany', '독일', 'Deutschland'] },
            { code: 'IT', label: '이탈리아', enLabel: 'Italy', aliases: ['Italy', '이탈리아'] },
            { code: 'ES', label: '스페인', enLabel: 'Spain', aliases: ['Spain', '스페인'] },
            { code: 'AU', label: '호주', enLabel: 'Australia', aliases: ['Australia', '호주'] },
            { code: 'CA', label: '캐나다', enLabel: 'Canada', aliases: ['Canada', '캐나다'] },
            { code: 'SG', label: '싱가포르', enLabel: 'Singapore', aliases: ['Singapore', '싱가포르'] },
            { code: 'TH', label: '태국', enLabel: 'Thailand', aliases: ['Thailand', '태국'] },
            { code: 'VN', label: '베트남', enLabel: 'Vietnam', aliases: ['Vietnam', '베트남'] },
            { code: 'TW', label: '대만', enLabel: 'Taiwan', aliases: ['Taiwan', '대만'] },
            { code: 'HK', label: '홍콩', enLabel: 'Hong Kong', aliases: ['Hong Kong', '홍콩'] },
            { code: 'MY', label: '말레이시아', enLabel: 'Malaysia', aliases: ['Malaysia', '말레이시아'] },
            { code: 'ID', label: '인도네시아', enLabel: 'Indonesia', aliases: ['Indonesia', '인도네시아'] },
            { code: 'PH', label: '필리핀', enLabel: 'Philippines', aliases: ['Philippines', '필리핀'] },
            { code: 'IN', label: '인도', enLabel: 'India', aliases: ['India', '인도'] },
            { code: 'BR', label: '브라질', enLabel: 'Brazil', aliases: ['Brazil', '브라질'] },
            { code: 'MX', label: '멕시코', enLabel: 'Mexico', aliases: ['Mexico', '멕시코'] },
            { code: 'AR', label: '아르헨티나', enLabel: 'Argentina', aliases: ['Argentina', '아르헨티나'] },
            { code: 'CL', label: '칠레', enLabel: 'Chile', aliases: ['Chile', '칠레'] },
            { code: 'PE', label: '페루', enLabel: 'Peru', aliases: ['Peru', '페루'] },
            { code: 'CO', label: '콜롬비아', enLabel: 'Colombia', aliases: ['Colombia', '콜롬비아'] },
            { code: 'ZA', label: '남아프리카공화국', enLabel: 'South Africa', aliases: ['South Africa', '남아프리카', 'SA'] },
            { code: 'EG', label: '이집트', enLabel: 'Egypt', aliases: ['Egypt', '이집트'] },
            { code: 'MA', label: '모로코', enLabel: 'Morocco', aliases: ['Morocco', '모로코'] },
            { code: 'TR', label: '터키', enLabel: 'Turkey', aliases: ['Turkey', '터키'] },
            { code: 'RU', label: '러시아', enLabel: 'Russia', aliases: ['Russia', '러시아'] },
            { code: 'UA', label: '우크라이나', enLabel: 'Ukraine', aliases: ['Ukraine', '우크라이나'] },
            { code: 'PL', label: '폴란드', enLabel: 'Poland', aliases: ['Poland', '폴란드'] },
            { code: 'CZ', label: '체코', enLabel: 'Czech Republic', aliases: ['Czech Republic', '체코', 'Czechia'] },
            { code: 'HU', label: '헝가리', enLabel: 'Hungary', aliases: ['Hungary', '헝가리'] },
            { code: 'AT', label: '오스트리아', enLabel: 'Austria', aliases: ['Austria', '오스트리아'] },
            { code: 'CH', label: '스위스', enLabel: 'Switzerland', aliases: ['Switzerland', '스위스'] },
            { code: 'NL', label: '네덜란드', enLabel: 'Netherlands', aliases: ['Netherlands', '네덜란드', 'Holland'] },
            { code: 'BE', label: '벨기에', enLabel: 'Belgium', aliases: ['Belgium', '벨기에'] },
            { code: 'SE', label: '스웨덴', enLabel: 'Sweden', aliases: ['Sweden', '스웨덴'] },
            { code: 'NO', label: '노르웨이', enLabel: 'Norway', aliases: ['Norway', '노르웨이'] },
            { code: 'DK', label: '덴마크', enLabel: 'Denmark', aliases: ['Denmark', '덴마크'] },
            { code: 'FI', label: '핀란드', enLabel: 'Finland', aliases: ['Finland', '핀란드'] },
            { code: 'IE', label: '아일랜드', enLabel: 'Ireland', aliases: ['Ireland', '아일랜드'] },
            { code: 'PT', label: '포르투갈', enLabel: 'Portugal', aliases: ['Portugal', '포르투갈'] },
            { code: 'GR', label: '그리스', enLabel: 'Greece', aliases: ['Greece', '그리스'] },
            { code: 'HR', label: '크로아티아', enLabel: 'Croatia', aliases: ['Croatia', '크로아티아'] },
            { code: 'SI', label: '슬로베니아', enLabel: 'Slovenia', aliases: ['Slovenia', '슬로베니아'] },
            { code: 'SK', label: '슬로바키아', enLabel: 'Slovakia', aliases: ['Slovakia', '슬로바키아'] },
            { code: 'RO', label: '루마니아', enLabel: 'Romania', aliases: ['Romania', '루마니아'] },
            { code: 'BG', label: '불가리아', enLabel: 'Bulgaria', aliases: ['Bulgaria', '불가리아'] },
            { code: 'RS', label: '세르비아', enLabel: 'Serbia', aliases: ['Serbia', '세르비아'] },
            { code: 'ME', label: '몬테네그로', enLabel: 'Montenegro', aliases: ['Montenegro', '몬테네그로'] },
            { code: 'MK', label: '북마케도니아', enLabel: 'North Macedonia', aliases: ['North Macedonia', '북마케도니아', 'Macedonia'] },
            { code: 'AL', label: '알바니아', enLabel: 'Albania', aliases: ['Albania', '알바니아'] },
            { code: 'BA', label: '보스니아헤르체고비나', enLabel: 'Bosnia and Herzegovina', aliases: ['Bosnia and Herzegovina', '보스니아', 'Bosnia'] },
            { code: 'XK', label: '코소보', enLabel: 'Kosovo', aliases: ['Kosovo', '코소보'] },
            { code: 'LV', label: '라트비아', enLabel: 'Latvia', aliases: ['Latvia', '라트비아'] },
            { code: 'LT', label: '리투아니아', enLabel: 'Lithuania', aliases: ['Lithuania', '리투아니아'] },
            { code: 'EE', label: '에스토니아', enLabel: 'Estonia', aliases: ['Estonia', '에스토니아'] },
            { code: 'IS', label: '아이슬란드', enLabel: 'Iceland', aliases: ['Iceland', '아이슬란드'] },
            { code: 'LU', label: '룩셈부르크', enLabel: 'Luxembourg', aliases: ['Luxembourg', '룩셈부르크'] },
            { code: 'LI', label: '리히텐슈타인', enLabel: 'Liechtenstein', aliases: ['Liechtenstein', '리히텐슈타인'] },
            { code: 'MC', label: '모나코', enLabel: 'Monaco', aliases: ['Monaco', '모나코'] },
            { code: 'SM', label: '산마리노', enLabel: 'San Marino', aliases: ['San Marino', '산마리노'] },
            { code: 'VA', label: '바티칸', enLabel: 'Vatican City', aliases: ['Vatican City', '바티칸', 'Holy See'] },
            { code: 'AD', label: '안도라', enLabel: 'Andorra', aliases: ['Andorra', '안도라'] },
            { code: 'MT', label: '몰타', enLabel: 'Malta', aliases: ['Malta', '몰타'] },
            { code: 'CY', label: '키프로스', enLabel: 'Cyprus', aliases: ['Cyprus', '키프로스'] },
            { code: 'GI', label: '지브롤터', enLabel: 'Gibraltar', aliases: ['Gibraltar', '지브롤터'] },
            { code: 'IM', label: '맨섬', enLabel: 'Isle of Man', aliases: ['Isle of Man', '맨섬'] },
            { code: 'JE', label: '저지', enLabel: 'Jersey', aliases: ['Jersey', '저지'] },
            { code: 'GG', label: '건지', enLabel: 'Guernsey', aliases: ['Guernsey', '건지'] },
            { code: 'FO', label: '페로제도', enLabel: 'Faroe Islands', aliases: ['Faroe Islands', '페로제도'] },
            { code: 'GL', label: '그린란드', enLabel: 'Greenland', aliases: ['Greenland', '그린란드'] },
            { code: 'AX', label: '올란드제도', enLabel: 'Åland Islands', aliases: ['Åland Islands', '올란드제도'] },
            { code: 'SJ', label: '스발바르제도', enLabel: 'Svalbard and Jan Mayen', aliases: ['Svalbard and Jan Mayen', '스발바르제도'] },
            { code: 'BV', label: '부베섬', enLabel: 'Bouvet Island', aliases: ['Bouvet Island', '부베섬'] },
            { code: 'TF', label: '프랑스령남부지역', enLabel: 'French Southern Territories', aliases: ['French Southern Territories', '프랑스령남부지역'] },
            { code: 'HM', label: '허드맥도널드제도', enLabel: 'Heard Island and McDonald Islands', aliases: ['Heard Island and McDonald Islands', '허드맥도널드제도'] },
            { code: 'AQ', label: '남극', enLabel: 'Antarctica', aliases: ['Antarctica', '남극'] },
            { code: 'IO', label: '영국령인도양지역', enLabel: 'British Indian Ocean Territory', aliases: ['British Indian Ocean Territory', '영국령인도양지역'] },
            { code: 'CX', label: '크리스마스섬', enLabel: 'Christmas Island', aliases: ['Christmas Island', '크리스마스섬'] },
            { code: 'CC', label: '코코스제도', enLabel: 'Cocos (Keeling) Islands', aliases: ['Cocos (Keeling) Islands', '코코스제도'] },
            { code: 'NF', label: '노퍽섬', enLabel: 'Norfolk Island', aliases: ['Norfolk Island', '노퍽섬'] },
            { code: 'PN', label: '핏케언제도', enLabel: 'Pitcairn', aliases: ['Pitcairn', '핏케언제도'] },
            { code: 'TK', label: '토켈라우', enLabel: 'Tokelau', aliases: ['Tokelau', '토켈라우'] },
            { code: 'NU', label: '니우에', enLabel: 'Niue', aliases: ['Niue', '니우에'] },
            { code: 'CK', label: '쿡제도', enLabel: 'Cook Islands', aliases: ['Cook Islands', '쿡제도'] },
            { code: 'WS', label: '사모아', enLabel: 'Samoa', aliases: ['Samoa', '사모아'] },
            { code: 'TO', label: '통가', enLabel: 'Tonga', aliases: ['Tonga', '통가'] },
            { code: 'FJ', label: '피지', enLabel: 'Fiji', aliases: ['Fiji', '피지'] },
            { code: 'VU', label: '바누아투', enLabel: 'Vanuatu', aliases: ['Vanuatu', '바누아투'] },
            { code: 'NC', label: '뉴칼레도니아', enLabel: 'New Caledonia', aliases: ['New Caledonia', '뉴칼레도니아'] },
            { code: 'PF', label: '프랑스령폴리네시아', enLabel: 'French Polynesia', aliases: ['French Polynesia', '프랑스령폴리네시아'] },
            { code: 'WF', label: '왈리스푸투나', enLabel: 'Wallis and Futuna', aliases: ['Wallis and Futuna', '왈리스푸투나'] },
            { code: 'AS', label: '미국령사모아', enLabel: 'American Samoa', aliases: ['American Samoa', '미국령사모아'] },
            { code: 'GU', label: '괌', enLabel: 'Guam', aliases: ['Guam', '괌'] },
            { code: 'MP', label: '북마리아나제도', enLabel: 'Northern Mariana Islands', aliases: ['Northern Mariana Islands', '북마리아나제도'] },
            { code: 'PW', label: '팔라우', enLabel: 'Palau', aliases: ['Palau', '팔라우'] },
            { code: 'FM', label: '미크로네시아', enLabel: 'Micronesia', aliases: ['Micronesia', '미크로네시아'] },
            { code: 'MH', label: '마셜제도', enLabel: 'Marshall Islands', aliases: ['Marshall Islands', '마셜제도'] },
            { code: 'KI', label: '키리바시', enLabel: 'Kiribati', aliases: ['Kiribati', '키리바시'] },
            { code: 'NR', label: '나우루', enLabel: 'Nauru', aliases: ['Nauru', '나우루'] },
            { code: 'TV', label: '투발루', enLabel: 'Tuvalu', aliases: ['Tuvalu', '투발루'] },
            { code: 'SB', label: '솔로몬제도', enLabel: 'Solomon Islands', aliases: ['Solomon Islands', '솔로몬제도'] },
            { code: 'PG', label: '파푸아뉴기니', enLabel: 'Papua New Guinea', aliases: ['Papua New Guinea', '파푸아뉴기니'] },
            { code: 'AU', label: '호주', enLabel: 'Australia', aliases: ['Australia', '호주'] },
            { code: 'NZ', label: '뉴질랜드', enLabel: 'New Zealand', aliases: ['New Zealand', '뉴질랜드'] },
            { code: 'NC', label: '뉴칼레도니아', enLabel: 'New Caledonia', aliases: ['New Caledonia', '뉴칼레도니아'] },
            { code: 'PF', label: '프랑스령폴리네시아', enLabel: 'French Polynesia', aliases: ['French Polynesia', '프랑스령폴리네시아'] },
            { code: 'WF', label: '왈리스푸투나', enLabel: 'Wallis and Futuna', aliases: ['Wallis and Futuna', '왈리스푸투나'] },
            { code: 'AS', label: '미국령사모아', enLabel: 'American Samoa', aliases: ['American Samoa', '미국령사모아'] },
            { code: 'GU', label: '괌', enLabel: 'Guam', aliases: ['Guam', '괌'] },
            { code: 'MP', label: '북마리아나제도', enLabel: 'Northern Mariana Islands', aliases: ['Northern Mariana Islands', '북마리아나제도'] },
            { code: 'PW', label: '팔라우', enLabel: 'Palau', aliases: ['Palau', '팔라우'] },
            { code: 'FM', label: '미크로네시아', enLabel: 'Micronesia', aliases: ['Micronesia', '미크로네시아'] },
            { code: 'MH', label: '마셜제도', enLabel: 'Marshall Islands', aliases: ['Marshall Islands', '마셜제도'] },
            { code: 'KI', label: '키리바시', enLabel: 'Kiribati', aliases: ['Kiribati', '키리바시'] },
            { code: 'NR', label: '나우루', enLabel: 'Nauru', aliases: ['Nauru', '나우루'] },
            { code: 'TV', label: '투발루', enLabel: 'Tuvalu', aliases: ['Tuvalu', '투발루'] },
            { code: 'SB', label: '솔로몬제도', enLabel: 'Solomon Islands', aliases: ['Solomon Islands', '솔로몬제도'] },
            { code: 'PG', label: '파푸아뉴기니', enLabel: 'Papua New Guinea', aliases: ['Papua New Guinea', '파푸아뉴기니'] }
        ];

        // 모달 관련 요소들
        const floatingBtn = document.getElementById('floating-btn');
        const modalOverlay = document.getElementById('modal-overlay');
        const closeModal = document.getElementById('close-modal');
        const cancelBtn = document.getElementById('cancel-btn');
        const travelForm = document.getElementById('travel-form');
        
        // 국가 자동완성 관련 요소들
        const countryInput = document.getElementById('country-input');
        const countryCode = document.getElementById('country-code');
        const countryLabel = document.getElementById('country-label');
        const countryDropdown = document.getElementById('country-dropdown');
        
        // 도시 자동완성 관련 요소들
        const cityInput = document.getElementById('city-input');
        const cityName = document.getElementById('city-name');
        const cityDropdown = document.getElementById('city-dropdown');
        
        // 도시 좌표 매핑 테이블
        const cityCoordinates = {
            // 한국 도시들
            "서울": { lat: 37.5665, lng: 126.9780 },
            "부산": { lat: 35.1796, lng: 129.0756 },
            "대구": { lat: 35.8714, lng: 128.6014 },
            "인천": { lat: 37.4563, lng: 126.7052 },
            "광주": { lat: 35.1595, lng: 126.8526 },
            "대전": { lat: 36.3504, lng: 127.3845 },
            "울산": { lat: 35.5384, lng: 129.3114 },
            "제주": { lat: 33.4996, lng: 126.5312 },
            "수원": { lat: 37.2636, lng: 127.0286 },
            "고양": { lat: 37.6584, lng: 126.8320 },
            "용인": { lat: 37.2411, lng: 127.1776 },
            "창원": { lat: 35.2278, lng: 128.6817 },
            "성남": { lat: 37.4449, lng: 127.1389 },
            "부천": { lat: 37.5035, lng: 126.7660 },
            "안산": { lat: 37.3219, lng: 126.8309 },
            "전주": { lat: 35.8242, lng: 127.1479 },
            "천안": { lat: 36.8154, lng: 127.1139 },
            "청주": { lat: 36.6424, lng: 127.4890 },
            "포항": { lat: 36.0320, lng: 129.3650 },
            "안양": { lat: 37.3922, lng: 126.9269 },
            
            // 일본 도시들
            "도쿄": { lat: 35.6895, lng: 139.6917 },
            "오사카": { lat: 34.6937, lng: 135.5023 },
            "교토": { lat: 35.0116, lng: 135.7681 },
            "요코하마": { lat: 35.4437, lng: 139.6380 },
            "나고야": { lat: 35.1815, lng: 136.9066 },
            "삿포로": { lat: 43.0618, lng: 141.3545 },
            "고베": { lat: 34.6901, lng: 135.1955 },
            "후쿠오카": { lat: 33.5902, lng: 130.4017 },
            "가와사키": { lat: 35.5309, lng: 139.7030 },
            "히로시마": { lat: 34.3853, lng: 132.4553 },
            "센다이": { lat: 38.2688, lng: 140.8721 },
            "지바": { lat: 35.6073, lng: 140.1063 },
            "기타큐슈": { lat: 33.8833, lng: 130.8833 },
            "사카이": { lat: 34.5733, lng: 135.4833 },
            "니가타": { lat: 37.9161, lng: 139.0364 },
            "하마마쓰": { lat: 34.7108, lng: 137.7261 },
            "구마모토": { lat: 32.7898, lng: 130.7417 },
            "사가미하라": { lat: 35.5714, lng: 139.3750 },
            "오카야마": { lat: 34.6618, lng: 133.9344 },
            "시즈오카": { lat: 34.9769, lng: 138.3831 },
            "히메지": { lat: 34.8167, lng: 134.7000 },
            
            // 미국 도시들
            "뉴욕": { lat: 40.7128, lng: -74.0060 },
            "로스앤젤레스": { lat: 34.0522, lng: -118.2437 },
            "시카고": { lat: 41.8781, lng: -87.6298 },
            "휴스턴": { lat: 29.7604, lng: -95.3698 },
            "피닉스": { lat: 33.4484, lng: -112.0740 },
            "필라델피아": { lat: 39.9526, lng: -75.1652 },
            "샌안토니오": { lat: 29.4241, lng: -98.4936 },
            "샌디에고": { lat: 32.7157, lng: -117.1611 },
            "댈러스": { lat: 32.7767, lng: -96.7970 },
            "샌호세": { lat: 37.3382, lng: -121.8863 },
            "오스틴": { lat: 30.2672, lng: -97.7431 },
            "잭슨빌": { lat: 30.3322, lng: -81.6557 },
            "포트워스": { lat: 32.7555, lng: -97.3308 },
            "콜럼버스": { lat: 39.9612, lng: -82.9988 },
            "샬럿": { lat: 35.2271, lng: -80.8431 },
            "샌프란시스코": { lat: 37.7749, lng: -122.4194 },
            "인디애나폴리스": { lat: 39.7684, lng: -86.1581 },
            "시애틀": { lat: 47.6062, lng: -122.3321 },
            "덴버": { lat: 39.7392, lng: -104.9903 },
            "워싱턴": { lat: 38.9072, lng: -77.0369 },
            "보스턴": { lat: 42.3601, lng: -71.0589 },
            
            // 영국 도시들
            "런던": { lat: 51.5074, lng: -0.1278 },
            "버밍엄": { lat: 52.4862, lng: -1.8904 },
            "리즈": { lat: 53.8008, lng: -1.5491 },
            "글래스고": { lat: 55.8642, lng: -4.2518 },
            "셰필드": { lat: 53.3811, lng: -1.4701 },
            "브래드포드": { lat: 53.7958, lng: -1.7594 },
            "에든버러": { lat: 55.9533, lng: -3.1883 },
            "리버풀": { lat: 53.4084, lng: -2.9916 },
            "맨체스터": { lat: 53.4808, lng: -2.2426 },
            "브리스틀": { lat: 51.4545, lng: -2.5879 },
            "웨이크필드": { lat: 53.6833, lng: -1.4977 },
            "카디프": { lat: 51.4816, lng: -3.1791 },
            "코벤트리": { lat: 52.4068, lng: -1.5197 },
            "레스터": { lat: 52.6369, lng: -1.1398 },
            "스토크온트렌트": { lat: 53.0027, lng: -2.1794 },
            "울버햄튼": { lat: 52.5862, lng: -2.1286 },
            "노팅엄": { lat: 52.9548, lng: -1.1581 },
            "플리머스": { lat: 50.3755, lng: -4.1427 },
            "사우샘프턴": { lat: 50.9097, lng: -1.4044 },
            "레딩": { lat: 51.4543, lng: -0.9781 },
            "더비": { lat: 52.9225, lng: -1.4746 },
            
            // 프랑스 도시들
            "파리": { lat: 48.8566, lng: 2.3522 },
            "마르세유": { lat: 43.2965, lng: 5.3698 },
            "리옹": { lat: 45.7578, lng: 4.8320 },
            "툴루즈": { lat: 43.6047, lng: 1.4442 },
            "니스": { lat: 43.7102, lng: 7.2620 },
            "낭트": { lat: 47.2184, lng: -1.5536 },
            "스트라스부르": { lat: 48.5734, lng: 7.7521 },
            "몽펠리에": { lat: 43.6108, lng: 3.8767 },
            "보르도": { lat: 44.8378, lng: -0.5792 },
            "릴": { lat: 50.6292, lng: 3.0573 },
            "렌": { lat: 48.1173, lng: -1.6778 },
            "르아브르": { lat: 49.4944, lng: 0.1079 },
            "생테티엔": { lat: 45.4408, lng: 4.3872 },
            "툴롱": { lat: 43.1242, lng: 5.9280 },
            "그르노블": { lat: 45.1885, lng: 5.7245 },
            "디종": { lat: 47.3220, lng: 5.0415 },
            "앙제": { lat: 47.4736, lng: -0.5542 },
            "생드니": { lat: 48.9362, lng: 2.3574 },
            "빌뢰반": { lat: 45.7640, lng: 4.8357 },
            "르망": { lat: 47.9959, lng: 0.2018 },
            "엑상프로방스": { lat: 43.5297, lng: 5.4474 },
            
            // 독일 도시들
            "베를린": { lat: 52.5200, lng: 13.4050 },
            "함부르크": { lat: 53.5511, lng: 9.9937 },
            "뮌헨": { lat: 48.1351, lng: 11.5820 },
            "쾰른": { lat: 50.9375, lng: 6.9603 },
            "프랑크푸르트": { lat: 50.1109, lng: 8.6821 },
            "슈투트가르트": { lat: 48.7758, lng: 9.1829 },
            "뒤셀도르프": { lat: 51.2277, lng: 6.7735 },
            "도르트문트": { lat: 51.5136, lng: 7.4653 },
            "에센": { lat: 51.4556, lng: 7.0116 },
            "라이프치히": { lat: 51.3397, lng: 12.3731 },
            "브레멘": { lat: 53.0793, lng: 8.8017 },
            "드레스덴": { lat: 51.0504, lng: 13.7373 },
            "하노버": { lat: 52.3759, lng: 9.7320 },
            "뉘른베르크": { lat: 49.4521, lng: 11.0767 },
            "뒤스부르크": { lat: 51.4344, lng: 6.7623 },
            "보훔": { lat: 51.4818, lng: 7.2162 },
            "부퍼탈": { lat: 51.2562, lng: 7.1508 },
            "빌레펠트": { lat: 52.0302, lng: 8.5325 },
            "본": { lat: 50.7374, lng: 7.0982 },
            "만하임": { lat: 49.4875, lng: 8.4660 },
            "카를스루에": { lat: 49.0069, lng: 8.4037 }
        };

        // 도시 데이터 (국가별 도시 목록)
        const cities = {
            'KR': [
                { name: '서울', enName: 'Seoul', aliases: ['Seoul', '서울', '서울특별시'] },
                { name: '부산', enName: 'Busan', aliases: ['Busan', '부산', '부산광역시'] },
                { name: '대구', enName: 'Daegu', aliases: ['Daegu', '대구', '대구광역시'] },
                { name: '인천', enName: 'Incheon', aliases: ['Incheon', '인천', '인천광역시'] },
                { name: '광주', enName: 'Gwangju', aliases: ['Gwangju', '광주', '광주광역시'] },
                { name: '대전', enName: 'Daejeon', aliases: ['Daejeon', '대전', '대전광역시'] },
                { name: '울산', enName: 'Ulsan', aliases: ['Ulsan', '울산', '울산광역시'] },
                { name: '제주', enName: 'Jeju', aliases: ['Jeju', '제주', '제주특별자치도'] },
                { name: '수원', enName: 'Suwon', aliases: ['Suwon', '수원', '수원시'] },
                { name: '고양', enName: 'Goyang', aliases: ['Goyang', '고양', '고양시'] },
                { name: '용인', enName: 'Yongin', aliases: ['Yongin', '용인', '용인시'] },
                { name: '창원', enName: 'Changwon', aliases: ['Changwon', '창원', '창원시'] },
                { name: '성남', enName: 'Seongnam', aliases: ['Seongnam', '성남', '성남시'] },
                { name: '부천', enName: 'Bucheon', aliases: ['Bucheon', '부천', '부천시'] },
                { name: '안산', enName: 'Ansan', aliases: ['Ansan', '안산', '안산시'] },
                { name: '전주', enName: 'Jeonju', aliases: ['Jeonju', '전주', '전주시'] },
                { name: '천안', enName: 'Cheonan', aliases: ['Cheonan', '천안', '천안시'] },
                { name: '청주', enName: 'Cheongju', aliases: ['Cheongju', '청주', '청주시'] },
                { name: '포항', enName: 'Pohang', aliases: ['Pohang', '포항', '포항시'] },
                { name: '안양', enName: 'Anyang', aliases: ['Anyang', '안양', '안양시'] }
            ],
            'JP': [
                { name: '도쿄', enName: 'Tokyo', aliases: ['Tokyo', '도쿄', '東京'] },
                { name: '오사카', enName: 'Osaka', aliases: ['Osaka', '오사카', '大阪'] },
                { name: '교토', enName: 'Kyoto', aliases: ['Kyoto', '교토', '京都'] },
                { name: '요코하마', enName: 'Yokohama', aliases: ['Yokohama', '요코하마', '横浜'] },
                { name: '나고야', enName: 'Nagoya', aliases: ['Nagoya', '나고야', '名古屋'] },
                { name: '삿포로', enName: 'Sapporo', aliases: ['Sapporo', '삿포로', '札幌'] },
                { name: '고베', enName: 'Kobe', aliases: ['Kobe', '고베', '神戸'] },
                { name: '후쿠오카', enName: 'Fukuoka', aliases: ['Fukuoka', '후쿠오카', '福岡'] },
                { name: '가와사키', enName: 'Kawasaki', aliases: ['Kawasaki', '가와사키', '川崎'] },
                { name: '히로시마', enName: 'Hiroshima', aliases: ['Hiroshima', '히로시마', '広島'] },
                { name: '센다이', enName: 'Sendai', aliases: ['Sendai', '센다이', '仙台'] },
                { name: '지바', enName: 'Chiba', aliases: ['Chiba', '지바', '千葉'] },
                { name: '기타큐슈', enName: 'Kitakyushu', aliases: ['Kitakyushu', '기타큐슈', '北九州'] },
                { name: '사카이', enName: 'Sakai', aliases: ['Sakai', '사카이', '堺'] },
                { name: '니가타', enName: 'Niigata', aliases: ['Niigata', '니가타', '新潟'] },
                { name: '하마마쓰', enName: 'Hamamatsu', aliases: ['Hamamatsu', '하마마쓰', '浜松'] },
                { name: '구마모토', enName: 'Kumamoto', aliases: ['Kumamoto', '구마모토', '熊本'] },
                { name: '사가미하라', enName: 'Sagamihara', aliases: ['Sagamihara', '사가미하라', '相模原'] },
                { name: '오카야마', enName: 'Okayama', aliases: ['Okayama', '오카야마', '岡山'] },
                { name: '시즈오카', enName: 'Shizuoka', aliases: ['Shizuoka', '시즈오카', '静岡'] },
                { name: '히메지', enName: 'Himeji', aliases: ['Himeji', '히메지', '姫路'] }
            ],
            'US': [
                { name: '뉴욕', enName: 'New York', aliases: ['New York', '뉴욕', 'NYC'] },
                { name: '로스앤젤레스', enName: 'Los Angeles', aliases: ['Los Angeles', '로스앤젤레스', 'LA'] },
                { name: '시카고', enName: 'Chicago', aliases: ['Chicago', '시카고'] },
                { name: '휴스턴', enName: 'Houston', aliases: ['Houston', '휴스턴'] },
                { name: '피닉스', enName: 'Phoenix', aliases: ['Phoenix', '피닉스'] },
                { name: '필라델피아', enName: 'Philadelphia', aliases: ['Philadelphia', '필라델피아'] },
                { name: '샌안토니오', enName: 'San Antonio', aliases: ['San Antonio', '샌안토니오'] },
                { name: '샌디에고', enName: 'San Diego', aliases: ['San Diego', '샌디에고'] },
                { name: '댈러스', enName: 'Dallas', aliases: ['Dallas', '댈러스'] },
                { name: '샌호세', enName: 'San Jose', aliases: ['San Jose', '샌호세'] },
                { name: '오스틴', enName: 'Austin', aliases: ['Austin', '오스틴'] },
                { name: '잭슨빌', enName: 'Jacksonville', aliases: ['Jacksonville', '잭슨빌'] },
                { name: '포트워스', enName: 'Fort Worth', aliases: ['Fort Worth', '포트워스'] },
                { name: '콜럼버스', enName: 'Columbus', aliases: ['Columbus', '콜럼버스'] },
                { name: '샬럿', enName: 'Charlotte', aliases: ['Charlotte', '샬럿'] },
                { name: '샌프란시스코', enName: 'San Francisco', aliases: ['San Francisco', '샌프란시스코', 'SF'] },
                { name: '인디애나폴리스', enName: 'Indianapolis', aliases: ['Indianapolis', '인디애나폴리스'] },
                { name: '시애틀', enName: 'Seattle', aliases: ['Seattle', '시애틀'] },
                { name: '덴버', enName: 'Denver', aliases: ['Denver', '덴버'] },
                { name: '워싱턴', enName: 'Washington', aliases: ['Washington', '워싱턴', 'DC'] },
                { name: '보스턴', enName: 'Boston', aliases: ['Boston', '보스턴'] }
            ],
            'GB': [
                { name: '런던', enName: 'London', aliases: ['London', '런던'] },
                { name: '버밍엄', enName: 'Birmingham', aliases: ['Birmingham', '버밍엄'] },
                { name: '리즈', enName: 'Leeds', aliases: ['Leeds', '리즈'] },
                { name: '글래스고', enName: 'Glasgow', aliases: ['Glasgow', '글래스고'] },
                { name: '셰필드', enName: 'Sheffield', aliases: ['Sheffield', '셰필드'] },
                { name: '브래드포드', enName: 'Bradford', aliases: ['Bradford', '브래드포드'] },
                { name: '에든버러', enName: 'Edinburgh', aliases: ['Edinburgh', '에든버러'] },
                { name: '리버풀', enName: 'Liverpool', aliases: ['Liverpool', '리버풀'] },
                { name: '맨체스터', enName: 'Manchester', aliases: ['Manchester', '맨체스터'] },
                { name: '브리스틀', enName: 'Bristol', aliases: ['Bristol', '브리스틀'] },
                { name: '웨이크필드', enName: 'Wakefield', aliases: ['Wakefield', '웨이크필드'] },
                { name: '카디프', enName: 'Cardiff', aliases: ['Cardiff', '카디프'] },
                { name: '코벤트리', enName: 'Coventry', aliases: ['Coventry', '코벤트리'] },
                { name: '레스터', enName: 'Leicester', aliases: ['Leicester', '레스터'] },
                { name: '스토크온트렌트', enName: 'Stoke-on-Trent', aliases: ['Stoke-on-Trent', '스토크온트렌트'] },
                { name: '울버햄튼', enName: 'Wolverhampton', aliases: ['Wolverhampton', '울버햄튼'] },
                { name: '노팅엄', enName: 'Nottingham', aliases: ['Nottingham', '노팅엄'] },
                { name: '플리머스', enName: 'Plymouth', aliases: ['Plymouth', '플리머스'] },
                { name: '사우샘프턴', enName: 'Southampton', aliases: ['Southampton', '사우샘프턴'] },
                { name: '레딩', enName: 'Reading', aliases: ['Reading', '레딩'] },
                { name: '더비', enName: 'Derby', aliases: ['Derby', '더비'] }
            ],
            'FR': [
                { name: '파리', enName: 'Paris', aliases: ['Paris', '파리'] },
                { name: '마르세유', enName: 'Marseille', aliases: ['Marseille', '마르세유'] },
                { name: '리옹', enName: 'Lyon', aliases: ['Lyon', '리옹'] },
                { name: '툴루즈', enName: 'Toulouse', aliases: ['Toulouse', '툴루즈'] },
                { name: '니스', enName: 'Nice', aliases: ['Nice', '니스'] },
                { name: '낭트', enName: 'Nantes', aliases: ['Nantes', '낭트'] },
                { name: '스트라스부르', enName: 'Strasbourg', aliases: ['Strasbourg', '스트라스부르'] },
                { name: '몽펠리에', enName: 'Montpellier', aliases: ['Montpellier', '몽펠리에'] },
                { name: '보르도', enName: 'Bordeaux', aliases: ['Bordeaux', '보르도'] },
                { name: '릴', enName: 'Lille', aliases: ['Lille', '릴'] },
                { name: '렌', enName: 'Rennes', aliases: ['Rennes', '렌'] },
                { name: '르아브르', enName: 'Le Havre', aliases: ['Le Havre', '르아브르'] },
                { name: '생테티엔', enName: 'Saint-Étienne', aliases: ['Saint-Étienne', '생테티엔'] },
                { name: '툴롱', enName: 'Toulon', aliases: ['Toulon', '툴롱'] },
                { name: '그르노블', enName: 'Grenoble', aliases: ['Grenoble', '그르노블'] },
                { name: '디종', enName: 'Dijon', aliases: ['Dijon', '디종'] },
                { name: '앙제', enName: 'Angers', aliases: ['Angers', '앙제'] },
                { name: '생드니', enName: 'Saint-Denis', aliases: ['Saint-Denis', '생드니'] },
                { name: '빌뢰반', enName: 'Villeurbanne', aliases: ['Villeurbanne', '빌뢰반'] },
                { name: '르망', enName: 'Le Mans', aliases: ['Le Mans', '르망'] },
                { name: '엑상프로방스', enName: 'Aix-en-Provence', aliases: ['Aix-en-Provence', '엑상프로방스'] }
            ],
            'DE': [
                { name: '베를린', enName: 'Berlin', aliases: ['Berlin', '베를린'] },
                { name: '함부르크', enName: 'Hamburg', aliases: ['Hamburg', '함부르크'] },
                { name: '뮌헨', enName: 'Munich', aliases: ['Munich', '뮌헨', 'München'] },
                { name: '쾰른', enName: 'Cologne', aliases: ['Cologne', '쾰른', 'Köln'] },
                { name: '프랑크푸르트', enName: 'Frankfurt', aliases: ['Frankfurt', '프랑크푸르트'] },
                { name: '슈투트가르트', enName: 'Stuttgart', aliases: ['Stuttgart', '슈투트가르트'] },
                { name: '뒤셀도르프', enName: 'Düsseldorf', aliases: ['Düsseldorf', '뒤셀도르프'] },
                { name: '도르트문트', enName: 'Dortmund', aliases: ['Dortmund', '도르트문트'] },
                { name: '에센', enName: 'Essen', aliases: ['Essen', '에센'] },
                { name: '라이프치히', enName: 'Leipzig', aliases: ['Leipzig', '라이프치히'] },
                { name: '브레멘', enName: 'Bremen', aliases: ['Bremen', '브레멘'] },
                { name: '드레스덴', enName: 'Dresden', aliases: ['Dresden', '드레스덴'] },
                { name: '하노버', enName: 'Hanover', aliases: ['Hanover', '하노버', 'Hannover'] },
                { name: '뉘른베르크', enName: 'Nuremberg', aliases: ['Nuremberg', '뉘른베르크', 'Nürnberg'] },
                { name: '뒤스부르크', enName: 'Duisburg', aliases: ['Duisburg', '뒤스부르크'] },
                { name: '보훔', enName: 'Bochum', aliases: ['Bochum', '보훔'] },
                { name: '부퍼탈', enName: 'Wuppertal', aliases: ['Wuppertal', '부퍼탈'] },
                { name: '빌레펠트', enName: 'Bielefeld', aliases: ['Bielefeld', '빌레펠트'] },
                { name: '본', enName: 'Bonn', aliases: ['Bonn', '본'] },
                { name: '만하임', enName: 'Mannheim', aliases: ['Mannheim', '만하임'] },
                { name: '카를스루에', enName: 'Karlsruhe', aliases: ['Karlsruhe', '카를스루에'] }
            ]
        };

        // localStorage에서 데이터 불러오기
        function loadEntries() {
            const savedEntries = localStorage.getItem('travelEntries');
            entries = savedEntries ? JSON.parse(savedEntries) : [];
            
            // 기존 entries에 ID가 없는 경우 ID 추가
            entries.forEach(entry => {
                if (!entry.id) {
                    entry.id = Date.now().toString() + Math.random().toString(36).substr(2, 9);
                }
            });
            
            // ID가 추가된 경우 localStorage 업데이트
            if (savedEntries) {
                saveEntries();
            }
        }

        // localStorage에 데이터 저장
        function saveEntries() {
            localStorage.setItem('travelEntries', JSON.stringify(entries));
        }
        
        // 사용자별 데이터 불러오기 (향후 로그인 시스템 대비)
        function loadUserData() {
            if (currentUser.isLoggedIn && currentUser.id) {
                const userDataKey = `user_${currentUser.id}_travelEntries`;
                const savedEntries = localStorage.getItem(userDataKey);
                entries = savedEntries ? JSON.parse(savedEntries) : [];
            } else {
                // 현재는 기존 방식 유지 (비로그인 사용자용)
                const savedEntries = localStorage.getItem('travelEntries');
                entries = savedEntries ? JSON.parse(savedEntries) : [];
            }
            
            // 기존 entries에 ID가 없는 경우 ID 추가
            entries.forEach(entry => {
                if (!entry.id) {
                    entry.id = Date.now().toString() + Math.random().toString(36).substr(2, 9);
                }
            });
            
            // ID가 추가된 경우 localStorage 업데이트
            if (entries.length > 0) {
                saveUserData();
            }
        }

        // 사용자별 데이터 저장 (향후 로그인 시스템 대비)
        function saveUserData() {
            if (currentUser.isLoggedIn && currentUser.id) {
                const userDataKey = `user_${currentUser.id}_travelEntries`;
                localStorage.setItem(userDataKey, JSON.stringify(entries));
            } else {
                // 현재는 기존 방식 유지 (비로그인 사용자용)
                localStorage.setItem('travelEntries', JSON.stringify(entries));
            }
        }
        
        // 국가 필터링 함수
        function filterCountries(query) {
            if (!query) return countries;
            const lowerQuery = query.toLowerCase();
            return countries.filter(country => 
                country.label.toLowerCase().includes(lowerQuery) ||
                country.enLabel.toLowerCase().includes(lowerQuery) ||
                country.code.toLowerCase().includes(lowerQuery) ||
                country.aliases.some(alias => alias.toLowerCase().includes(lowerQuery))
            );
        }
        
        // 도시 필터링 함수
        function filterCities(query, countryCode) {
            if (!countryCode || !cities[countryCode]) return [];
            if (!query) return cities[countryCode];
            
            const lowerQuery = query.toLowerCase();
            return cities[countryCode].filter(city => 
                city.name.toLowerCase().includes(lowerQuery) ||
                city.enName.toLowerCase().includes(lowerQuery) ||
                city.aliases.some(alias => alias.toLowerCase().includes(lowerQuery))
            );
        }
        
        // 국가 드롭다운 렌더링
        function renderCountryDropdown(filteredCountries) {
            if (filteredCountries.length === 0) {
                countryDropdown.innerHTML = '<li class="px-3 py-2 text-gray-500 text-sm">일치하는 국가가 없습니다.</li>';
                countryDropdown.classList.remove('hidden');
                return;
            }
            
            countryDropdown.innerHTML = filteredCountries.map(country => `
                <li class="country-option px-3 py-2 hover:bg-blue-50 cursor-pointer text-sm" 
                    data-code="${country.code}" 
                    data-label="${country.label}">
                    <span class="font-medium">${country.label}</span>
                    <span class="text-gray-500 ml-2">(${country.code})</span>
                </li>
            `).join('');
            
            countryDropdown.classList.remove('hidden');
        }
        
        // 도시 드롭다운 렌더링
        function renderCityDropdown(filteredCities) {
            if (filteredCities.length === 0) {
                cityDropdown.innerHTML = '<li class="px-3 py-2 text-gray-500 text-sm">일치하는 도시가 없습니다.</li>';
                cityDropdown.classList.remove('hidden');
                return;
            }
            
            cityDropdown.innerHTML = filteredCities.map(city => `
                <li class="city-option px-3 py-2 hover:bg-blue-50 cursor-pointer text-sm" 
                    data-name="${city.name}" 
                    data-en-name="${city.enName}">
                    <span class="font-medium">${city.name}</span>
                    <span class="text-gray-500 ml-2">(${city.enName})</span>
                </li>
            `).join('');
            
            cityDropdown.classList.remove('hidden');
        }
        
        // 국가 선택 처리
        function selectCountry(code, label) {
            countryInput.value = label;
            countryCode.value = code;
            countryLabel.value = label;
            countryDropdown.classList.add('hidden');
            
            // 도시 입력 필드 활성화 및 초기화
            cityInput.disabled = false;
            cityInput.value = '';
            cityName.value = '';
            cityInput.placeholder = '도시명을 입력하거나 선택하세요';
        }
        
        // 국가 입력값 자동 매칭
        function autoSelectCountry(inputValue) {
            const filteredCountries = filterCountries(inputValue);
            if (filteredCountries.length === 1) {
                const country = filteredCountries[0];
                selectCountry(country.code, country.label);
                return true;
            }
            return false;
        }
        
        // 도시 선택 처리
        function selectCity(name, enName) {
            cityInput.value = name;
            cityName.value = name;
            cityDropdown.classList.add('hidden');
        }
        
        // 도시 입력값 자동 매칭
        function autoSelectCity(inputValue, countryCode) {
            const filteredCities = filterCities(inputValue, countryCode);
            if (filteredCities.length === 1) {
                const city = filteredCities[0];
                selectCity(city.name, city.enName);
                return true;
            }
            return false;
        }



        // 목적 텍스트 변환 함수
        function getPurposeText(purpose) {
            const textMap = {
                'travel': '여행',
                'business': '출장',
                'study': '유학',
                'working-holiday': '워킹 홀리데이',
                'family-visit': '가족 방문',
                'dispatch': '파견',
                'exchange': '교환학생',
                'volunteer': '봉사활동',
                'medical': '의료',
                'language': '어학 연수',
                'transit': '비행 경유'
            };
            return textMap[purpose] || purpose;
        }

        // 툴팁 생성 함수
        function createTooltip(event, tooltipContent) {
            // 기존 툴팁 제거
            const existingTooltip = document.querySelector('.calendar-tooltip');
            if (existingTooltip) {
                existingTooltip.remove();
            }

            const tooltip = document.createElement('div');
            tooltip.className = 'calendar-tooltip fixed z-50 bg-gray-900 text-white text-sm rounded-lg px-3 py-2 shadow-lg max-w-xs pointer-events-none space-y-1';
            
            // 텍스트를 줄바꿈으로 분리하여 HTML로 변환
            const lines = tooltipContent.split('\\n');
            const htmlContent = lines.map((line, index) => {
                const escapedLine = line.replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;');
                if (index === 0) {
                    return `<div class="font-semibold">${escapedLine}</div>`;
                } else {
                    return `<div class="text-gray-300">${escapedLine}</div>`;
                }
            }).join('');
            tooltip.innerHTML = htmlContent;
            
            document.body.appendChild(tooltip);

            // 툴팁 위치 계산
            const rect = event.target.getBoundingClientRect();
            const tooltipRect = tooltip.getBoundingClientRect();
            
            let left = rect.left + (rect.width / 2) - (tooltipRect.width / 2);
            let top = rect.bottom + 8;

            // 화면 경계 체크
            if (left < 8) left = 8;
            if (left + tooltipRect.width > window.innerWidth - 8) {
                left = window.innerWidth - tooltipRect.width - 8;
            }
            if (top + tooltipRect.height > window.innerHeight - 8) {
                top = rect.top - tooltipRect.height - 8;
            }

            tooltip.style.left = left + 'px';
            tooltip.style.top = top + 'px';
        }

        // 툴팁 제거 함수
        function removeTooltip() {
            const tooltip = document.querySelector('.calendar-tooltip');
            if (tooltip) {
                tooltip.remove();
            }
        }

        // 모바일 터치 이벤트 처리
        let touchTimeout = null;
        let activeTooltip = null;

        function handleTouchEvent(event, tooltipContent) {
            event.preventDefault();
            
            if (activeTooltip) {
                // 이미 열린 툴팁이 있으면 닫기
                removeTooltip();
                activeTooltip = null;
            } else {
                // 툴팁 열기
                createTooltip(event, tooltipContent);
                activeTooltip = event.target;
                
                // 다른 곳 터치 시 툴팁 닫기
                setTimeout(() => {
                    document.addEventListener('touchstart', function closeTooltip(e) {
                        if (!event.target.contains(e.target)) {
                            removeTooltip();
                            activeTooltip = null;
                            document.removeEventListener('touchstart', closeTooltip);
                        }
                    }, { once: true });
                }, 100);
            }
        }

        // 날짜 차이 계산 (체류일 수)
        function calculateDays(startDate, endDate) {
            const start = new Date(startDate);
            const end = new Date(endDate);
            const diffTime = Math.abs(end - start);
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
            return diffDays + 1; // 시작일 포함
        }

        // 통계 계산
        function calculateStats() {
            if (entries.length === 0) {
                document.getElementById('total-countries').textContent = '0';
                document.getElementById('total-cities').textContent = '0';
                document.getElementById('total-days').textContent = '0';
                document.getElementById('travel-summary').innerHTML = '<p class="text-gray-500">아직 등록된 여행이 없습니다.</p>';
                return;
            }

            // 중복 제거된 국가와 도시
            const countries = [...new Set(entries.map(entry => entry.country))];
            const cities = [...new Set(entries.map(entry => entry.city))];
            
            // 총 체류일 계산
            const totalDays = entries.reduce((sum, entry) => {
                return sum + calculateDays(entry.startDate, entry.endDate);
            }, 0);

            // 통계 업데이트
            document.getElementById('total-countries').textContent = countries.length;
            document.getElementById('total-cities').textContent = cities.length;
            document.getElementById('total-days').textContent = totalDays;

            // 요약 정보 생성
            const summaryHTML = `
                <div class="space-y-2">
                    <p><strong>총 여행 횟수:</strong> ${entries.length}회</p>
                    <p><strong>방문 국가:</strong> ${countries.join(', ')}</p>
                    <p><strong>방문 도시:</strong> ${cities.join(', ')}</p>
                    <p><strong>평균 체류일:</strong> ${Math.round(totalDays / entries.length)}일</p>
                </div>
            `;
            document.getElementById('travel-summary').innerHTML = summaryHTML;
        }

        // 타임라인 렌더링
        function renderTimeline() {
            const timelineList = document.getElementById('timeline-list');
            const timelineEmpty = document.getElementById('timeline-empty');

            if (entries.length === 0) {
                timelineList.style.display = 'none';
                timelineEmpty.style.display = 'block';
                return;
            }

            timelineList.style.display = 'block';
            timelineEmpty.style.display = 'none';

            // 날짜순으로 정렬 (최신순)
            const sortedEntries = [...entries].sort((a, b) => new Date(b.startDate) - new Date(a.startDate));

            timelineList.innerHTML = sortedEntries.map(entry => {
                const days = calculateDays(entry.startDate, entry.endDate);
                const purposeText = {
                    'travel': '여행',
                    'business': '출장',
                    'study': '유학',
                    'working-holiday': '워킹 홀리데이',
                    'family-visit': '가족 방문',
                    'dispatch': '파견',
                    'exchange': '교환학생',
                    'volunteer': '봉사활동',
                    'medical': '의료',
                    'language': '어학 연수',
                    'transit': '비행 경유'
                }[entry.purpose] || entry.purpose;

                return `
                    <div class="bg-white border border-gray-200 rounded-lg p-6 shadow-sm hover:shadow-md transition-shadow">
                        <div class="flex justify-between items-start mb-3">
                            <div>
                                <h3 class="text-lg font-semibold text-gray-800">${entry.country} / ${entry.city}</h3>
                                <p class="text-sm text-gray-600">${purposeText}</p>
                            </div>
                            <div class="flex items-center space-x-2">
                                <span class="bg-blue-100 text-blue-800 text-xs font-medium px-2 py-1 rounded-full">
                                    ${days}일
                                </span>
                                <div class="flex space-x-1">
                                    <button onclick="modifyEntry('${entry.id}')" class="text-xs bg-yellow-100 text-yellow-700 px-2 py-1 rounded hover:bg-yellow-200 transition-colors">
                                        수정
                                    </button>
                                    <button onclick="deleteEntry('${entry.id}')" class="text-xs bg-red-100 text-red-700 px-2 py-1 rounded hover:bg-red-200 transition-colors">
                                        삭제
                                    </button>
                                </div>
                            </div>
                        </div>
                        <div class="text-sm text-gray-500 mb-3">
                            📅 ${entry.startDate} ~ ${entry.endDate}
                        </div>
                        ${entry.memo ? `<p class="text-sm text-gray-600 bg-gray-50 p-3 rounded">📝 ${entry.memo}</p>` : ''}
                    </div>
                `;
            }).join('');
        }

        // 캘린더 렌더링
        function renderCalendar() {
            const calendarBody = document.getElementById('calendar-body');
            const calendarEmpty = document.getElementById('calendar-empty');
            const currentMonthElement = document.getElementById('current-month');

            if (entries.length === 0) {
                calendarBody.style.display = 'none';
                calendarEmpty.style.display = 'block';
                return;
            }

            calendarBody.style.display = 'table-row-group';
            calendarEmpty.style.display = 'none';

            const year = currentDate.getFullYear();
            const month = currentDate.getMonth();
            
            currentMonthElement.textContent = `${year}년 ${month + 1}월`;

            const firstDay = new Date(year, month, 1);
            const lastDay = new Date(year, month + 1, 0);
            const startDate = new Date(firstDay);
            startDate.setDate(startDate.getDate() - firstDay.getDay());

            let calendarHTML = '';
            let currentRow = '';

            for (let i = 0; i < 42; i++) {
                const currentDate = new Date(startDate);
                currentDate.setDate(startDate.getDate() + i);

                if (i % 7 === 0 && i > 0) {
                    calendarHTML += `<tr>${currentRow}</tr>`;
                    currentRow = '';
                }

                const isCurrentMonth = currentDate.getMonth() === month;
                const isToday = currentDate.toDateString() === new Date().toDateString();
                
                // 해당 날짜의 일정 찾기
                const dayEvents = entries.filter(entry => {
                    const eventStart = new Date(entry.startDate);
                    const eventEnd = new Date(entry.endDate);
                    return currentDate >= eventStart && currentDate <= eventEnd;
                });

                let dayContent = `<div class="text-sm">${currentDate.getDate()}</div>`;
                
                if (dayEvents.length > 0) {
                    dayContent += `<div class="mt-1 space-y-1">`;
                    dayEvents.forEach((event, index) => {
                        const purposeText = getPurposeText(event.purpose);
                        
                        // 툴팁 내용을 안전하게 생성
                        const tooltipText = `${event.country} / ${event.city}\\n${purposeText}\\n📅 ${event.startDate} ~ ${event.endDate}${event.memo ? '\\n📝 ' + event.memo : ''}`;
                        
                        // 이벤트 색상 클래스 결정 (순환)
                        const colorClass = `event-${(index % 8) + 1}`;
                        
                        dayContent += `
                            <div class="calendar-event ${colorClass}"
                                 data-event-index="${index}"
                                 data-tooltip="${tooltipText.replace(/"/g, '&quot;')}"
                                 onmouseenter="createTooltip(event, this.dataset.tooltip)"
                                 onmouseleave="removeTooltip()"
                                 ontouchstart="handleTouchEvent(event, this.dataset.tooltip)"
                                 title="${event.country}">
                                ${event.country}
                            </div>
                        `;
                    });
                    dayContent += `</div>`;
                }

                const cellClass = `
                    border border-gray-200 p-2 h-28 align-top
                    ${isCurrentMonth ? 'bg-white' : 'bg-gray-50 text-gray-400'}
                    ${isToday ? 'bg-blue-50 border-blue-200' : ''}
                `;

                currentRow += `<td class="${cellClass}">${dayContent}</td>`;
            }

            if (currentRow) {
                calendarHTML += `<tr>${currentRow}</tr>`;
            }

            calendarBody.innerHTML = calendarHTML;
        }

        // 지도 관련 변수들
        let map = null;
        let markers = [];
        let markerLayer = null;

        // 지도 초기화
        function initializeMap() {
            if (map) {
                map.remove();
            }

            // 지도 생성
            map = L.map('world-map').setView([20, 0], 2);

            // OpenStreetMap 타일 레이어 추가
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '© OpenStreetMap contributors',
                maxZoom: 18
            }).addTo(map);

            // 마커 레이어 생성
            markerLayer = L.layerGroup().addTo(map);

            // 지도 크기 재계산 (리사이징 문제 방지)
            setTimeout(() => {
                if (map) {
                    map.invalidateSize();
                }
            }, 100);

            // 지도 컨트롤 이벤트 리스너
            document.getElementById('fit-bounds-btn').addEventListener('click', fitBounds);
            document.getElementById('clear-markers-btn').addEventListener('click', hideMarkers);
            document.getElementById('show-markers-btn').addEventListener('click', showMarkers);
        }

        // 마커 생성 및 추가
        function createMarkers() {
            // 기존 마커 제거
            if (markerLayer) {
                markerLayer.clearLayers();
            }
            markers = [];

            // 중복 제거된 도시 목록 생성
            const uniqueCities = new Map();
            
            entries.forEach(entry => {
                const cityKey = `${entry.country}-${entry.city}`;
                if (!uniqueCities.has(cityKey)) {
                    uniqueCities.set(cityKey, {
                        country: entry.country,
                        city: entry.city,
                        entries: []
                    });
                }
                uniqueCities.get(cityKey).entries.push(entry);
            });

            // 각 도시에 대해 마커 생성
            uniqueCities.forEach((cityData, cityKey) => {
                const coordinates = cityCoordinates[cityData.city];
                if (coordinates) {
                    const marker = L.marker([coordinates.lat, coordinates.lng], {
                        icon: L.divIcon({
                            className: 'custom-marker',
                            html: '<div class="marker-pin">📍</div>',
                            iconSize: [30, 30],
                            iconAnchor: [15, 30]
                        })
                    });

                    // 팝업 내용 생성
                    const popupContent = createPopupContent(cityData);
                    marker.bindPopup(popupContent, {
                        maxWidth: 300,
                        className: 'custom-popup'
                    });

                    // 마커 클릭 이벤트
                    marker.on('click', function() {
                        showMarkerInfo(cityData);
                    });

                    marker.addTo(markerLayer);
                    markers.push(marker);
                }
            });
        }

        // 팝업 내용 생성
        function createPopupContent(cityData) {
            const purposeText = {
                'travel': '여행',
                'business': '출장',
                'study': '유학',
                'working-holiday': '워킹 홀리데이',
                'family-visit': '가족 방문',
                'dispatch': '파견',
                'exchange': '교환학생',
                'volunteer': '봉사활동',
                'medical': '의료',
                'language': '어학 연수',
                'transit': '비행 경유'
            };

            let content = `
                <div class="popup-content">
                    <h3 class="font-bold text-lg mb-2">${cityData.city}, ${cityData.country}</h3>
                    <div class="text-sm space-y-1">
            `;

            cityData.entries.forEach((entry, index) => {
                const purpose = purposeText[entry.purpose] || entry.purpose;
                const days = calculateDays(entry.startDate, entry.endDate);
                
                content += `
                    <div class="border-l-2 border-blue-500 pl-2 mb-2">
                        <div class="font-medium">${purpose}</div>
                        <div class="text-gray-600">📅 ${entry.startDate} ~ ${entry.endDate}</div>
                        <div class="text-gray-600">⏱️ ${days}일</div>
                        ${entry.memo ? `<div class="text-gray-600">📝 ${entry.memo}</div>` : ''}
                    </div>
                `;
            });

            content += `
                    </div>
                    <div class="text-xs text-gray-500 mt-2">
                        총 ${cityData.entries.length}회 방문
                    </div>
                </div>
            `;

            return content;
        }

        // 마커 정보 패널 표시
        function showMarkerInfo(cityData) {
            const panel = document.getElementById('marker-info-panel');
            const content = document.getElementById('marker-info-content');
            
            const purposeText = {
                'travel': '여행',
                'business': '출장',
                'study': '유학',
                'working-holiday': '워킹 홀리데이',
                'family-visit': '가족 방문',
                'dispatch': '파견',
                'exchange': '교환학생',
                'volunteer': '봉사활동',
                'medical': '의료',
                'language': '어학 연수',
                'transit': '비행 경유'
            };

            let infoContent = `
                <div class="space-y-3">
                    <div class="font-semibold text-lg">${cityData.city}, ${cityData.country}</div>
                    <div class="text-sm space-y-2">
            `;

            cityData.entries.forEach((entry, index) => {
                const purpose = purposeText[entry.purpose] || entry.purpose;
                const days = calculateDays(entry.startDate, entry.endDate);
                
                infoContent += `
                    <div class="bg-white p-3 rounded border">
                        <div class="font-medium text-blue-600">${purpose}</div>
                        <div class="text-gray-600">📅 ${entry.startDate} ~ ${entry.endDate}</div>
                        <div class="text-gray-600">⏱️ ${days}일</div>
                        ${entry.memo ? `<div class="text-gray-600 mt-1">📝 ${entry.memo}</div>` : ''}
                    </div>
                `;
            });

            infoContent += `
                    </div>
                    <div class="text-sm text-gray-500 border-t pt-2">
                        총 ${cityData.entries.length}회 방문
                    </div>
                </div>
            `;

            content.innerHTML = infoContent;
            panel.classList.remove('hidden');
        }

        // 지도 범위에 맞춰 보기
        function fitBounds() {
            if (markers.length > 0) {
                const group = new L.featureGroup(markers);
                map.fitBounds(group.getBounds().pad(0.1));
            } else {
                map.setView([20, 0], 2);
            }
        }

        // 마커 숨기기
        function hideMarkers() {
            if (markerLayer) {
                markerLayer.clearLayers();
            }
            document.getElementById('marker-info-panel').classList.add('hidden');
        }

        // 마커 보기
        function showMarkers() {
            createMarkers();
        }

        // 모든 섹션 업데이트
        function updateAllSections() {
            calculateStats();
            renderTimeline();
            renderCalendar();
            updateMap();
        }

        // 지도 업데이트
        function updateMap() {
            if (map) {
                createMarkers();
            }
        }

        // 수정 함수
        function modifyEntry(entryId) {
            const entry = entries.find(e => e.id === entryId);
            if (!entry) return;

            // 수정 모드 설정
            isEditMode = true;
            editingEntryId = entryId;

            // 모달 제목 변경
            document.querySelector('#modal-overlay h2').textContent = '여행 수정';

            // 폼에 기존 데이터 채우기
            document.getElementById('country-input').value = entry.country;
            document.getElementById('country-code').value = entry.countryCode;
            document.getElementById('country-label').value = entry.countryLabel;
            document.getElementById('city-input').value = entry.city;
            document.getElementById('city-name').value = entry.cityName;
            document.getElementById('start-date').value = entry.startDate;
            document.getElementById('end-date').value = entry.endDate;
            document.getElementById('purpose').value = entry.purpose;
            document.getElementById('memo').value = entry.memo || '';

            // 도시 입력 필드 활성화
            document.getElementById('city-input').disabled = false;

            // 제출 버튼 텍스트 변경
            const submitBtn = document.querySelector('#travel-form button[type="submit"]');
            submitBtn.textContent = '수정';

            // 모달 열기
            modalOverlay.classList.remove('hidden');
            modalOverlay.classList.add('flex');
            document.body.style.overflow = 'hidden';
        }

        // 삭제 함수
        function deleteEntry(entryId) {
            if (confirm('이 일정을 삭제하시겠습니까?')) {
                entries = entries.filter(entry => entry.id !== entryId);
                saveUserData();
                updateAllSections();
                alert('일정이 삭제되었습니다.');
            }
        }

        // 국가 자동완성 이벤트 리스너들
        countryInput.addEventListener('input', function() {
            const query = this.value;
            const filteredCountries = filterCountries(query);
            renderCountryDropdown(filteredCountries);
        });
        
        countryInput.addEventListener('focus', function() {
            if (this.value) {
                const filteredCountries = filterCountries(this.value);
                renderCountryDropdown(filteredCountries);
            } else {
                renderCountryDropdown(countries);
            }
        });
        
        countryInput.addEventListener('blur', function() {
            // 약간의 지연을 두어 클릭 이벤트가 처리될 수 있도록 함
            setTimeout(() => {
                countryDropdown.classList.add('hidden');
                
                // 국가가 선택되지 않았고 입력값이 있으면 자동 매칭 시도
                if (!countryCode.value && this.value.trim()) {
                    autoSelectCountry(this.value.trim());
                }
            }, 200);
        });
        
        // 국가 입력 필드에서 엔터 키 처리
        countryInput.addEventListener('keydown', function(e) {
            if (e.key === 'Enter') {
                e.preventDefault();
                if (!countryCode.value && this.value.trim()) {
                    autoSelectCountry(this.value.trim());
                }
            }
        });
        
        // 국가 옵션 클릭 이벤트 (이벤트 위임 사용)
        countryDropdown.addEventListener('click', function(e) {
            if (e.target.closest('.country-option')) {
                const option = e.target.closest('.country-option');
                const code = option.dataset.code;
                const label = option.dataset.label;
                selectCountry(code, label);
            }
        });
        
        // 도시 자동완성 이벤트 리스너들
        cityInput.addEventListener('input', function() {
            const query = this.value;
            const selectedCountryCode = document.getElementById('country-code').value;
            const filteredCities = filterCities(query, selectedCountryCode);
            renderCityDropdown(filteredCities);
        });
        
        cityInput.addEventListener('focus', function() {
            const selectedCountryCode = document.getElementById('country-code').value;
            if (!selectedCountryCode) {
                cityInput.placeholder = '먼저 국가를 선택해주세요';
                return;
            }
            
            if (this.value) {
                const filteredCities = filterCities(this.value, selectedCountryCode);
                renderCityDropdown(filteredCities);
            } else {
                renderCityDropdown(cities[selectedCountryCode] || []);
            }
        });
        
        cityInput.addEventListener('blur', function() {
            // 약간의 지연을 두어 클릭 이벤트가 처리될 수 있도록 함
            setTimeout(() => {
                cityDropdown.classList.add('hidden');
                
                // 도시가 선택되지 않았고 입력값이 있으면 자동 매칭 시도
                const selectedCountryCode = document.getElementById('country-code').value;
                if (!cityName.value && this.value.trim() && selectedCountryCode) {
                    autoSelectCity(this.value.trim(), selectedCountryCode);
                }
            }, 200);
        });
        
        // 도시 입력 필드에서 엔터 키 처리
        cityInput.addEventListener('keydown', function(e) {
            if (e.key === 'Enter') {
                e.preventDefault();
                const selectedCountryCode = document.getElementById('country-code').value;
                if (!cityName.value && this.value.trim() && selectedCountryCode) {
                    autoSelectCity(this.value.trim(), selectedCountryCode);
                }
            }
        });
        
        // 도시 옵션 클릭 이벤트 (이벤트 위임 사용)
        cityDropdown.addEventListener('click', function(e) {
            if (e.target.closest('.city-option')) {
                const option = e.target.closest('.city-option');
                const name = option.dataset.name;
                const enName = option.dataset.enName;
                selectCity(name, enName);
            }
        });
        
        // 모달 열기
        floatingBtn.addEventListener('click', function() {
            modalOverlay.classList.remove('hidden');
            modalOverlay.classList.add('flex');
            document.body.style.overflow = 'hidden';
        });

        // 모달 닫기 함수
        function closeModalFunction() {
            modalOverlay.classList.add('hidden');
            modalOverlay.classList.remove('flex');
            document.body.style.overflow = '';
            travelForm.reset();
            
            // 수정 모드 리셋
            isEditMode = false;
            editingEntryId = null;
            
            // 모달 제목과 버튼 텍스트 원래대로 복원
            document.querySelector('#modal-overlay h2').textContent = '새 여행 추가';
            const submitBtn = document.querySelector('#travel-form button[type="submit"]');
            submitBtn.textContent = '추가';
            
            // 도시 입력 필드 비활성화
            document.getElementById('city-input').disabled = true;
            document.getElementById('city-input').placeholder = '국가를 먼저 선택한 후 도시명을 입력하세요';
        }

        // X 버튼으로 모달 닫기
        closeModal.addEventListener('click', closeModalFunction);

        // 취소 버튼으로 모달 닫기
        cancelBtn.addEventListener('click', closeModalFunction);

        // 오버레이 클릭으로 모달 닫기
        modalOverlay.addEventListener('click', function(e) {
            if (e.target === modalOverlay) {
                closeModalFunction();
            }
        });

        // 날짜 유효성 검사 함수
        function validateDates() {
            const startDate = document.getElementById('start-date').value;
            const endDate = document.getElementById('end-date').value;
            
            if (startDate && endDate) {
                const start = new Date(startDate);
                const end = new Date(endDate);
                
                if (end < start) {
                    alert('체류 종료일은 체류 시작일보다 이전일 수 없습니다.');
                    return false;
                }
            }
            return true;
        }

        // 시작일 변경 시 종료일 최소값 설정
        document.getElementById('start-date').addEventListener('change', function() {
            const startDate = this.value;
            const endDateInput = document.getElementById('end-date');
            
            if (startDate) {
                endDateInput.min = startDate;
                
                // 현재 종료일이 시작일보다 이전이면 종료일을 시작일로 설정
                if (endDateInput.value && endDateInput.value < startDate) {
                    endDateInput.value = startDate;
                }
            }
        });

        // 종료일 변경 시 유효성 검사
        document.getElementById('end-date').addEventListener('change', function() {
            const startDate = document.getElementById('start-date').value;
            const endDate = this.value;
            
            if (startDate && endDate) {
                const start = new Date(startDate);
                const end = new Date(endDate);
                
                if (end < start) {
                    alert('체류 종료일은 체류 시작일보다 이전일 수 없습니다.');
                    this.value = startDate; // 종료일을 시작일로 설정
                }
            }
        });

        // 폼 제출 처리
        travelForm.addEventListener('submit', function(e) {
            e.preventDefault();
            
            // 날짜 유효성 검사
            if (!validateDates()) {
                return;
            }
            
            const formData = {
                country: document.getElementById('country-input').value,
                countryCode: document.getElementById('country-code').value,
                countryLabel: document.getElementById('country-label').value,
                city: document.getElementById('city-input').value,
                cityName: document.getElementById('city-name').value,
                startDate: document.getElementById('start-date').value,
                endDate: document.getElementById('end-date').value,
                purpose: document.getElementById('purpose').value,
                memo: document.getElementById('memo').value
            };

            if (isEditMode && editingEntryId) {
                // 수정 모드: 기존 entry 업데이트
                const index = entries.findIndex(e => e.id === editingEntryId);
                if (index !== -1) {
                    formData.id = editingEntryId; // 기존 ID 유지
                    entries[index] = formData;
                    saveUserData();
                    updateAllSections();
                    console.log('수정된 여행 데이터:', JSON.stringify(formData, null, 2));
                    closeModalFunction();
                    alert('여행이 성공적으로 수정되었습니다!');
                }
            } else {
                // 추가 모드: 새 entry 추가
                formData.id = Date.now().toString(); // 고유 ID 추가
                entries.push(formData);
                saveUserData();
                updateAllSections();
                console.log('여행 데이터:', JSON.stringify(formData, null, 2));
                closeModalFunction();
                alert('여행이 성공적으로 추가되었습니다!');
            }
        });

        // 연도/월 드롭다운 초기화
        function initializeCalendarDropdowns() {
            const yearSelect = document.getElementById('year-select');
            const monthSelect = document.getElementById('month-select');
            
            // 연도 옵션 생성 (현재 연도 기준 전후 10년)
            const currentYear = new Date().getFullYear();
            yearSelect.innerHTML = '';
            for (let year = currentYear - 10; year <= currentYear + 10; year++) {
                const option = document.createElement('option');
                option.value = year;
                option.textContent = year + '년';
                yearSelect.appendChild(option);
            }
            
            // 현재 연도/월로 설정
            yearSelect.value = currentDate.getFullYear();
            monthSelect.value = currentDate.getMonth();
        }

        // 연도/월 선택 시 캘린더 업데이트
        function updateCalendarFromDropdowns() {
            const yearSelect = document.getElementById('year-select');
            const monthSelect = document.getElementById('month-select');
            
            const selectedYear = parseInt(yearSelect.value);
            const selectedMonth = parseInt(monthSelect.value);
            
            currentDate.setFullYear(selectedYear);
            currentDate.setMonth(selectedMonth);
            renderCalendar();
        }

        // 캘린더 네비게이션
        document.getElementById('prev-month').addEventListener('click', function() {
            currentDate.setMonth(currentDate.getMonth() - 1);
            updateDropdownsFromCurrentDate();
            renderCalendar();
        });

        document.getElementById('next-month').addEventListener('click', function() {
            currentDate.setMonth(currentDate.getMonth() + 1);
            updateDropdownsFromCurrentDate();
            renderCalendar();
        });

        // 드롭다운 값 변경 이벤트 리스너
        document.getElementById('year-select').addEventListener('change', updateCalendarFromDropdowns);
        document.getElementById('month-select').addEventListener('change', updateCalendarFromDropdowns);

        // 현재 날짜에 맞춰 드롭다운 값 업데이트
        function updateDropdownsFromCurrentDate() {
            const yearSelect = document.getElementById('year-select');
            const monthSelect = document.getElementById('month-select');
            
            yearSelect.value = currentDate.getFullYear();
            monthSelect.value = currentDate.getMonth();
        }

        // 탭 클릭 이벤트 처리
        document.querySelectorAll('.nav-tab').forEach(tab => {
            tab.addEventListener('click', function() {
                const targetSection = this.getAttribute('data-section');
                
                // 모든 탭에서 active 클래스 제거
                document.querySelectorAll('.nav-tab').forEach(t => {
                    t.classList.remove('active');
                    t.classList.add('text-gray-600');
                });
                
                // 클릭된 탭에 active 클래스 추가
                this.classList.add('active');
                this.classList.remove('text-gray-600');
                
                // 모든 섹션 숨기기
                document.querySelectorAll('.content-section').forEach(section => {
                    section.classList.add('hidden');
                });
                
                // 해당 섹션 보이기
                const targetElement = document.getElementById(targetSection);
                if (targetElement) {
                    targetElement.classList.remove('hidden');
                    targetElement.classList.add('block');
                }

                // 캘린더 섹션으로 이동할 때 캘린더 다시 렌더링
                if (targetSection === 'calendar') {
                    updateDropdownsFromCurrentDate();
                    renderCalendar();
                }
                
                // 세계지도 섹션으로 이동할 때 지도 업데이트
                if (targetSection === 'world-map') {
                    setTimeout(() => {
                        if (map) {
                            map.invalidateSize();
                            createMarkers();
                        }
                    }, 100);
                }
            });
        });

        // 페이지 로드 시 초기화
        document.addEventListener('DOMContentLoaded', function() {
            loadUserData();
            updateAllSections();
            updateUserInterface();
            
            // 캘린더 드롭다운 초기화
            initializeCalendarDropdowns();
            
            // 지도 초기화 (약간의 지연을 두어 DOM이 완전히 로드된 후 실행)
            setTimeout(() => {
                initializeMap();
                createMarkers();
            }, 100);
            
            // 로그인/로그아웃 버튼 이벤트 리스너
            document.getElementById('login-btn').addEventListener('click', function() {
                // 향후 실제 로그인 시스템 연동 예정
                alert('로그인 기능은 향후 Firebase Auth 또는 Supabase Auth로 구현 예정입니다.');
            });
            
            document.getElementById('logout-btn').addEventListener('click', logout);
            
            // 설정 페이지 버튼 이벤트 리스너
            document.getElementById('demo-login-btn').addEventListener('click', demoLogin);
            document.getElementById('export-data-btn').addEventListener('click', exportData);
            document.getElementById('backup-data-btn').addEventListener('click', exportData);
            document.getElementById('reset-data-btn').addEventListener('click', resetData);
            
            // 준비 중인 기능들
            document.getElementById('dark-mode-toggle').addEventListener('click', function() {
                alert('다크 모드 기능은 향후 구현 예정입니다.');
            });
            
            document.getElementById('language-toggle').addEventListener('click', function() {
                alert('언어 설정 기능은 향후 구현 예정입니다.');
            });
        });

        // 사용자 인터페이스 업데이트
        function updateUserInterface() {
            const userInfo = document.getElementById('user-info');
            const loginBtn = document.getElementById('login-btn');
            const logoutBtn = document.getElementById('logout-btn');
            const loginStatus = document.getElementById('login-status');
            const usernameElement = document.getElementById('username');
            const userInitial = document.getElementById('user-initial');

            if (currentUser.isLoggedIn) {
                // 로그인된 상태
                userInfo.classList.remove('hidden');
                loginBtn.classList.add('hidden');
                logoutBtn.classList.remove('hidden');
                loginStatus.textContent = `로그인됨 (${currentUser.username})`;
                usernameElement.textContent = currentUser.username;
                userInitial.textContent = currentUser.username.charAt(0).toUpperCase();
            } else {
                // 로그인되지 않은 상태
                userInfo.classList.add('hidden');
                loginBtn.classList.remove('hidden');
                logoutBtn.classList.add('hidden');
                loginStatus.textContent = '로그인되지 않음';
            }
        }

        // 데모 로그인 함수
        function demoLogin() {
            currentUser = {
                id: 'demo_user_001',
                username: '데모 사용자',
                isLoggedIn: true
            };
            
            // 사용자별 데이터 로드
            loadUserData();
            updateUserInterface();
            updateAllSections();
            
            alert('데모 로그인이 완료되었습니다!');
        }

        // 로그아웃 함수
        function logout() {
            if (confirm('로그아웃하시겠습니까? 현재 데이터는 로컬에 저장됩니다.')) {
                currentUser = {
                    id: null,
                    username: null,
                    isLoggedIn: false
                };
                
                // 비로그인 사용자용 데이터 로드
                loadUserData();
                updateUserInterface();
                updateAllSections();
                
                alert('로그아웃되었습니다.');
            }
        }

        // 데이터 내보내기 함수
        function exportData() {
            const data = {
                user: currentUser,
                entries: entries,
                exportDate: new Date().toISOString()
            };
            
            const dataStr = JSON.stringify(data, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            const url = URL.createObjectURL(dataBlob);
            
            const link = document.createElement('a');
            link.href = url;
            link.download = `travel_data_${new Date().toISOString().split('T')[0]}.json`;
            link.click();
            
            URL.revokeObjectURL(url);
            alert('데이터가 성공적으로 내보내졌습니다!');
        }

        // 데이터 초기화 함수
        function resetData() {
            if (confirm('모든 여행 데이터를 삭제하시겠습니까? 이 작업은 되돌릴 수 없습니다.')) {
                entries = [];
                saveUserData();
                updateAllSections();
                alert('모든 데이터가 초기화되었습니다.');
            }
        }
    </script>
</body>
</html> 